<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Jedis 使用和原理 | 平心de小屋</title><meta name="keywords" content="数据库,NoSQL,Redis"><meta name="author" content="平心"><meta name="copyright" content="平心"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="redis协议规范（Redis Protocol specification）官网文档 https:&#x2F;&#x2F;redis.io&#x2F;topics&#x2F;protocol http:&#x2F;&#x2F;www.redis.cn&#x2F;topics&#x2F;protocol.html">
<meta property="og:type" content="article">
<meta property="og:title" content="Jedis 使用和原理">
<meta property="og:url" content="https://pingxin0521.gitee.io/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-1-3/index.html">
<meta property="og:site_name" content="平心de小屋">
<meta property="og:description" content="redis协议规范（Redis Protocol specification）官网文档 https:&#x2F;&#x2F;redis.io&#x2F;topics&#x2F;protocol http:&#x2F;&#x2F;www.redis.cn&#x2F;topics&#x2F;protocol.html">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg">
<meta property="article:published_time" content="2019-10-18T12:18:59.000Z">
<meta property="article:modified_time" content="2019-11-24T14:29:34.633Z">
<meta property="article:author" content="平心">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="NoSQL">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg"><link rel="shortcut icon" href="https://s2.ax1x.com/2020/02/11/1ovFOA.png"><link rel="canonical" href="https://pingxin0521.gitee.io/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-1-3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Jedis 使用和原理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2019-11-24 22:29:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/02/11/1ovw6J.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">449</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">77</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">68</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">平心de小屋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Jedis 使用和原理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-10-18T12:18:59.000Z" title="发表于 2019-10-18 20:18:59">2019-10-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2019-11-24T14:29:34.633Z" title="更新于 2019-11-24 22:29:34">2019-11-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/NoSQL/">NoSQL</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/NoSQL/Redis/">Redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>21分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Jedis 使用和原理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="redis协议规范（Redis-Protocol-specification）"><a href="#redis协议规范（Redis-Protocol-specification）" class="headerlink" title="redis协议规范（Redis Protocol specification）"></a>redis协议规范（Redis Protocol specification）</h3><p><strong>官网文档</strong></p>
<p><a target="_blank" rel="noopener" href="https://redis.io/topics/protocol">https://redis.io/topics/protocol</a></p>
<p><a target="_blank" rel="noopener" href="http://www.redis.cn/topics/protocol.html">http://www.redis.cn/topics/protocol.html</a></p>
<span id="more"></span>

<p>Redis服务器与客户端通过RESP（REdis Serialization Protocol）协议通信。</p>
<p>redis协议在以下几点之间做出了折衷：</p>
<ol>
<li>简单的实现</li>
<li>快速地被计算机解析</li>
<li>简单得可以能被人工解析</li>
<li>网络层，Redis在TCP端口6379上监听到来的连接（本质就是socket），客户端连接到来时，Redis服务器为此创建一个TCP连接。在客户端与服务器端之间传输的每个Redis命令或者数据都以\r\n结尾。</li>
</ol>
<p><strong>RESP协议支持的数据类型</strong></p>
<p><code>Simple String</code>第一个字节以<code>+</code>开头，随后紧跟内容字符串（不能包含<code>CR</code> <code>LF</code>），最后以<code>CRLF</code>结束。很多Redis命令执行成功时会返回”OK”，”OK”就是一个<code>Simple String</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;+OK\\r\\n&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>Error</code>的结构与<code>Simple String</code>很像，但是第一个字节以<code>-</code>开头：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;-ERR unknown command &#x27;foobar&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>-</code>符号后的第一个单词代表错误类型，ERR代表一般错误，WRONGTYPE代表在某种数据结构上执行了不支持的操作。</p>
<p><code>Integer</code>第一个字节以<code>:</code>开头，随后紧跟数字，以<code>CRLF</code>结束：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;:1000\\r\\n&quot;</span></span><br></pre></td></tr></table></figure>

<p>很多Redis命令会返回<code>Integer</code>,例如<code>INCR</code> <code>LLEN</code>等。</p>
<p><code>Bulk String</code>是一种二进制安全的字符串结构，整个结构包含两部分。第一部分以<code>$</code>开头，后面紧跟字符串的字节长度，<code>CRLF</code>结尾。第二部分是真正的字符串内容，<code>CRLF</code>结尾，最大长度限制为512MB。一个<code>Bulk String</code>结构的”Hello World!”是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;<span class="variable">$12</span>\\r\\nHello World!\\r\\n&quot;</span></span><br></pre></td></tr></table></figure>

<p>空字符串是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;<span class="variable">$0</span>\\r\\n\\r\\n&quot;</span>  </span><br></pre></td></tr></table></figure>

<p>nil是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;$-1\\r\\n&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>Array</code>也可以看成由两部分组成，第一部分以<code>*</code>开头，后面紧跟一个数字代表<code>Array</code>的长度，以<code>CRLF</code>结束。第二部分是每个元素的具体值，可能是<code>Integer</code>，可能是<code>Bulk String</code>。<code>Array</code>结构的[“hello”, “world”]是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;*2\\r\\n<span class="variable">$5</span>\\r\\nhello\\r\\n<span class="variable">$5</span>\\r\\nworld\\r\\n&quot;</span></span><br></pre></td></tr></table></figure>

<p>空<code>Array</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;*-1\\r\\n&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>基本通讯模型</strong></p>
<p>执行过程：发送指令–》执行命令–》返回结果</p>
<p>执行命令：单线程执行，所有命令进入队列，按顺序执行</p>
<p>单线程快的原因：纯内存访问，单线程避免线程切换和竞争产生资源消耗，RESP协议简单</p>
<p>问题：如果某个命令执行慢，会造成其他命令的阻塞</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/22/MHiMFJ.png" alt="MHiMFJ.png"></p>
<p><strong>请求</strong></p>
<p>Redis接收由不同参数组成的命令。一旦收到命令，将会立刻被处理，并回复给客户端</p>
<p><strong>新的统一请求协议</strong></p>
<p>在这个统一协议里，发送给Redis服务端的所有参数都是二进制安全的。以下是通用形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*后面数量表示存在几个$</span><br><span class="line">$后面数量表示字符串的长度</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">SET</span><br><span class="line">$5</span><br><span class="line">mykey</span><br><span class="line">$7</span><br><span class="line">myvalue</span><br></pre></td></tr></table></figure>

<p>上面的命令看上去像是单引号字符串，所以可以在查询中看到每个字节的准确值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;*3\r\n$3\r\nSET\r\n$5\r\nmykey\r\n$7\r\nmyvalue\r\n&quot;</span><br></pre></td></tr></table></figure>

<p>在Redis的回复中也使用这样的格式。批量回复时，这种格式用于每个参数$6\r\nmydata\r\n。 实际的统一请求协议是Redis用于返回列表项，并调用 Multi-bulk回复。 仅仅是N个以以*\r\n为前缀的不同批量回复，是紧随的参数（批量回复）数目。</p>
<p><strong>回复</strong></p>
<p>Redis用不同的回复类型回复命令。它可能从服务器发送的第一个字节开始校验回复类型(最小单元类型)：</p>
<ol>
<li>用单行回复，回复的第一个字节将是“+”</li>
<li>错误消息，回复的第一个字节将是“-”</li>
<li>整型数字，回复的第一个字节将是“:”</li>
<li>批量回复，回复的第一个字节将是“$”</li>
<li>多个批量回复，回复的第一个字节将是“*”</li>
</ol>
<p>注：每个单元结束时统一加上回车换行符号\r\n</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#单行字符串 hello</span><br><span class="line">+hello\r\n</span><br><span class="line">#多行字符串 hello，也支持表示单行字符串</span><br><span class="line">$11\r\nhello\r\n</span><br><span class="line">#NULL 用多行字符串表示，不过长度要写成-1</span><br><span class="line">$-1\r\n</span><br><span class="line">#空串 用多行字符串表示，长度填 0（因为两个\r\n之间,隔的是空串）</span><br><span class="line">$0\r\n\r\n</span><br><span class="line">#整数 1024</span><br><span class="line">:1024\r\n</span><br><span class="line">#错误 参数类型错误（错误消息不需要\r\n结尾）</span><br><span class="line">-WRONGTYPE unknown command</span><br><span class="line">#数组 [1,2,3]</span><br><span class="line">*3\r\n:1\r\n:2\r\n:3\r\n</span><br></pre></td></tr></table></figure>

<p><strong>模拟Redis服务和客户端通讯，实现RESP协议通信</strong></p>
<p>枚举类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">CommandRedis</span> </span>&#123;</span><br><span class="line">    SET, GET, SETNX</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> hyp</span></span><br><span class="line"><span class="comment"> * Project name is JavaLearn</span></span><br><span class="line"><span class="comment"> * Include in com.hyp.learn.redis</span></span><br><span class="line"><span class="comment"> * hyp create at 19-11-22</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisClientByResp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisClientByResp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> Socket(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;连接失败&quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求redis</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">postRequest</span><span class="params">(CommandRedis cr, String key, String value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        sb.append(<span class="string">&quot;*3&quot;</span>).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;$&quot;</span>).append(cr.name().length()).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        sb.append(cr.name()).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        <span class="comment">// 注意中文汉字。一个汉字两个字节，长度为2</span></span><br><span class="line">        sb.append(<span class="string">&quot;$&quot;</span>).append(key.getBytes().length).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        sb.append(key).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != value) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;$&quot;</span>).append(value.getBytes().length).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            sb.append(value).append(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">        socket.getOutputStream().write(sb.toString().getBytes());</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">64</span>];</span><br><span class="line">        sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        InputStream is = socket.getInputStream();</span><br><span class="line">        <span class="keyword">while</span> (is.available() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> len = is.read(b);</span><br><span class="line">            <span class="keyword">if</span> (len &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(<span class="keyword">new</span> String(b, <span class="number">0</span>, len));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">set</span><span class="params">(String key, String value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postRequest(CommandRedis.SET, key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postRequest(CommandRedis.GET, key, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置值：不会覆盖存在的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">setnx</span><span class="params">(String key, String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> postRequest(CommandRedis.SETNX, key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RedisClientByResp resp = <span class="keyword">new</span> RedisClientByResp();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(resp.set(<span class="string">&quot;mykey&quot;</span>, <span class="string">&quot;myvalue&quot;</span>));</span><br><span class="line">            System.out.println(resp.get(<span class="string">&quot;mykey&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!resp.socket.isConnected()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    resp.socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Jedis使用"><a href="#Jedis使用" class="headerlink" title="Jedis使用"></a>Jedis使用</h3><p>Jedis是Redis的Java客户端，连接池使用commons-pool2</p>
<p> Jedis Client是Redis官网推荐的一个面向java客户端，库文件实现了对redis各类API进行封装调用。redis通信协议是Redis客户端与Redis Server之间交流的语言，它规定了请求和返回值的格式。redis-cli与server端使用一种专门为redis设计的协议RESP(Redis Serialization Protocol)交互，Resp本身没有指定TCP，但redis上下文只使用TCP连接。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/redis.clients/jedis --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Jedis对应Redis的四种工作模式</strong></p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbBo4K.png" alt="MbBo4K.png"></p>
<p>Jedis的主要模块，Jedis,JedisCluster,JedisSentinel和ShardedJedis对应了Redis的四种工作模式：Redis Standalone（单节点模式）,Redis Cluster（集群模式）,Redis Sentinel（哨兵模式）和Redis Sharding（分片模式）。</p>
<p><strong>Jedis的三种请求模式</strong></p>
<p>每个Jedis实例对应一个Redis节点，我们对Jedis实例的每个操作，都相当于使用<code>redis-cli</code>启动客户端的直接操作。无论是集群模式，哨兵模式，还是分片模式，内部均为对Jedis实例的操作。所以了解Jedis类的内部结构及Jedis实例的请求模式是掌握Jedis框架的基础。</p>
<p> Jedis实例有3种请求模式，Pipeline，Transaction和Client。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbBjHI.png" alt="MbBjHI.png"></p>
<p>Jedis实例通过<strong>Socket</strong>建立客户端与服务端的长连接，往<strong>outputStream</strong>发送命令，从<strong>inputStream</strong>读取回复，</p>
<ol>
<li><p>Client模式</p>
<p> Client模式就是常用的“所见即所得”，客户端发一个命令，阻塞等待服务端执行，然后读取返回结果。优点是确保每次处理都有结果，一旦发现返回结果中有Error,就可以立即处理。</p>
</li>
<li><p>Pipeline模式</p>
<p>Pipeline模式则是一次性发送多个命令，最后一次取回所有的返回结果，这种模式通过减少网络的往返时间和IO的读写次数，大幅度提高通信性能，但Pipeline不支持原子性，如果想保证原子性，可同时开启事务模式。</p>
</li>
<li><p>Transaction模式</p>
<p>Transaction模式即开启Redis的事务管理，Pipeline可以在事务中，也可以不在事务中。事务模式开启后，所有的命令（除了 <strong>EXEC</strong> 、 <strong>DISCARD</strong> 、 <strong>MULTI</strong> 和 <strong>WATCH</strong> ）到达服务端以后，不会立即执行，会进入一个等待队列，等到收到下述四个命令时执行不同操作：</p>
<ul>
<li><p><strong>EXEC</strong>命令执行时， 服务器以先进先出（FIFO）的方式执行事务队列中的命令,当事务队列里的所有命令被执行完之后， 将回复队列作为自己的执行结果返回给客户端， 客户端从事务状态返回到非事务状态， 至此， 事务执行完毕。</p>
</li>
<li><p><strong>DISCARD</strong>命令用于取消一个事务， 它清空客户端的整个事务队列， 然后将客户端从事务状态调整回非事务状态， 最后返回字符串 OK 给客户端， 说明事务已被取消。</p>
</li>
<li><p><strong>Redis</strong> 的事务是不可嵌套的， 当客户端已经处于事务状态， 而客户端又再向服务器发送MULTI时， 服务器只是简单地向客户端发送一个错误， 然后继续等待其他命令的入队。 MULTI命令的发送不会造成整个事务失败， 也不会修改事务队列中已有的数据。</p>
</li>
<li><p><strong>WATCH</strong>只能在客户端进入事务状态之前执行， 在事务状态下发送 WATCH命令会引发一个错误， 但它不会造成整个事务失败， 也不会修改事务队列中已有的数据（和前面处理 MULTI的情况一样）。</p>
</li>
</ul>
</li>
</ol>
<p>Jedis主要有两条业务逻辑：</p>
<ol>
<li>初始化的过程</li>
<li>发送命令的过程。</li>
</ol>
<h4 id="Jedis对象"><a href="#Jedis对象" class="headerlink" title="Jedis对象"></a>Jedis对象</h4><p><strong>Jedis</strong>对象的继承关系：<code>Jedis</code>—&gt;<code>BinaryJedis</code>- -&gt;<code>BasicCommands</code> 、<code>BinaryJedisCommands</code>等，其中<code>BinaryJedis</code>组合了<strong>Client</strong>对象(<code>Client</code>—&gt;<code>BinaryClient</code>—&gt;<code>Connection</code>，<strong>Connection</strong>对象组合了<strong>socket</strong>、<strong>输入输出</strong>流等连接对象)</p>
<h5 id="Jedis的初始化流程"><a href="#Jedis的初始化流程" class="headerlink" title="Jedis的初始化流程"></a>Jedis的初始化流程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>, <span class="number">15000</span>);</span><br><span class="line">Transaction t = jedis.multi();</span><br><span class="line">Pipeline pipeline = jedis.pipelined();</span><br></pre></td></tr></table></figure>

<p> Jedis通过传入Redis服务器地址（host,port）开始初始化，然后在BinaryJedis里实例化Client。Client通过<strong>Socket</strong>维持客户端与Redis服务器的连接与沟通。<br>前文提到Transaction和Pipeline很相似，它们继承同一个基类<code>MultiKeyPipelineBase</code>。区别在于Transaction在实例化的时候，就自动发送<strong>MULTI</strong>命令，开启事务模式，而Pipeline则按情况手动开启，它们均依靠Client发送命令。以下是Transaction和Pipeline初始化的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//BinaryJedis类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">multi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">client.multi();</span><br><span class="line">transaction = <span class="keyword">new</span> Transaction(client);</span><br><span class="line"><span class="keyword">return</span> transaction;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Pipeline <span class="title">pipelined</span><span class="params">()</span> </span>&#123;</span><br><span class="line">pipeline = <span class="keyword">new</span> Pipeline();</span><br><span class="line">pipeline.setClient(client);</span><br><span class="line"><span class="keyword">return</span> pipeline;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 下面通过发送一个<code>get key</code> 的命令，看看，这三种模式是如何运转的。</p>
<h4 id="JedisPool"><a href="#JedisPool" class="headerlink" title="JedisPool"></a>JedisPool</h4><h5 id="JedisPool初始化"><a href="#JedisPool初始化" class="headerlink" title="JedisPool初始化"></a>JedisPool初始化</h5><p><strong>JedisPool</strong>的构造方法很多（可以改造成Builder Pattern，更清晰），可以通过<strong>JedisConfig</strong>进行配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">config.setMaxActive(MAX_ACTIVE);</span><br><span class="line">config.setMaxIdle(MAX_IDLE);</span><br><span class="line">config.setMaxWait(MAX_WAIT);</span><br><span class="line">config.setMaxWait(MAX_WAIT);</span><br><span class="line">config.setTestOnBorrow(TEST_ON_BORROW);</span><br><span class="line">jedisPool = <span class="keyword">new</span> JedisPool(config, ADDR, PORT, TIMEOUT, AUTH);</span><br></pre></td></tr></table></figure>

<p><strong>JedisPool</strong>的继承关系：<code>JedisPool</code> —&gt;<code>JedisPoolAbstract</code>—&gt;<code>Pool</code></p>
<p><strong>JedisPool</strong>的构造，依赖于抽象父类<code>Pool</code>的构造函数，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Pool中内置的属性是commons-pool2的GenericObjectPool</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GenericObjectPool internalPool;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pool</span><span class="params">(<span class="keyword">final</span> GenericObjectPoolConfig poolConfig, PooledObjectFactory&lt;T&gt; factory)</span> </span>&#123;</span><br><span class="line">    initPool(poolConfig, factory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initPool</span><span class="params">(<span class="keyword">final</span> GenericObjectPoolConfig poolConfig, PooledObjectFactory&lt;T&gt; factory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">this</span>.internalPool = <span class="keyword">new</span> GenericObjectPool&lt;T&gt;(factory, poolConfig);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>Pool</strong>中内置的属性是<strong>commons-pool2</strong>的<code>GenericObjectPool</code>，即最终的连接池对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GenericObjectPool</span><span class="params">(<span class="keyword">final</span> PooledObjectFactory&lt;T&gt; factory,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> GenericObjectPoolConfig config)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">this</span>.factory = factory;</span><br><span class="line">    idleObjects = <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;(config.getFairness());</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中构造参数<code>final PooledObjectFactory factory</code>，是外层构造时传入的<code>JedisFactory</code>，其实现了接口<code>PoolObjectFactory</code>，并实现了<code>makeObject()</code>等相关方法，即产生<strong>Jedis</strong>类的真正工厂。</p>
<h5 id="Jedis连接获取"><a href="#Jedis连接获取" class="headerlink" title="Jedis连接获取"></a>Jedis连接获取</h5><p>上文提到的<code>makeObject()</code>真正被调用的时候，是在连接获取时，进行调用并创建Jedis对象 (当然是有条件的，即下文提到的存活队列中无可用对象，并未达到上限时)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> PooledObject&lt;T&gt; <span class="title">create</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">//判断连接池容量的逻辑...</span></span><br><span class="line">    <span class="keyword">final</span> PooledObject&lt;T&gt; p;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        p = factory.makeObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">        createCount.decrementAndGet();</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (makeObjectCountLock) &#123;</span><br><span class="line">            makeObjectCount--;</span><br><span class="line">            <span class="comment">//此处唤醒所有等待连接的线程</span></span><br><span class="line">            makeObjectCountLock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Jedis连接关闭"><a href="#Jedis连接关闭" class="headerlink" title="Jedis连接关闭"></a>Jedis连接关闭</h5><p>这里必须要提到，在连接池对象中(<code>GenericObjectPool</code>)的一个重要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LinkedBlockingDeque&lt;PooledObject&lt;T&gt;&gt; idleObjects;</span><br></pre></td></tr></table></figure>

<p>这个阻塞队列是维护存活<strong>Jedis</strong>对象的容器，当连接关闭时，<strong>Jedis</strong>对象归还连接池，即存入此队列，保持连接的存活。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> maxIdleSave = getMaxIdle();</span><br><span class="line">    <span class="keyword">if</span> (isClosed() || maxIdleSave &gt; -<span class="number">1</span> &amp;&amp; maxIdleSave &lt;= idleObjects.size()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                    destroy(p);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">        swallowException(e);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="keyword">if</span> (getLifo()) &#123;</span><br><span class="line">                    idleObjects.addFirst(p);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                idleObjects.addLast(p);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>工具类</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hanyunpeng0521/JavaLearn/blob/master/src/main/java/com/hyp/learn/redis/RedisUtils.java">https://github.com/hanyunpeng0521/JavaLearn/blob/master/src/main/java/com/hyp/learn/redis/RedisUtils.java</a></p>
<h4 id="Jedis工作模式的调用流程"><a href="#Jedis工作模式的调用流程" class="headerlink" title="Jedis工作模式的调用流程"></a>Jedis工作模式的调用流程</h4><h5 id="client请求模式"><a href="#client请求模式" class="headerlink" title="client请求模式"></a>client请求模式</h5><p>以<code>get key</code> 为例，为突出主要步骤，部分代码略有缩减。<br>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jedis.get(&quot;foo&quot;);</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbrRT1.png" alt="MbrRT1.png"></p>
<p>调用流程:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbsXDJ.png" alt="MbsXDJ.png"></p>
<p>client模式下，发送请求，读取回复的具体实现。可以清楚看到，在每次发送命令前，会先通过<code>connect()</code>方法判断是否已经连接，若未连接则进行如下操作：</p>
<ol>
<li>实例化Socket，并配置，</li>
<li>连接Socket,获取OutputStream和InputStream</li>
<li>如果是SSL连接，则会通过SSLSocketFactory创建socket连接</li>
</ol>
<p> <strong>Protocol</strong>是一个通讯工具类，将Redis的各类执行关键字存储为静态变量，可以直观调用命令，例如<code>Protocol.Command.GET</code>。同时，将命令包装成符合<a target="_blank" rel="noopener" href="http://www.redis.cn/topics/protocol.html">Redis的统一请求协议</a>，回复消息的处理也是在这个类进行，先通过通讯协提取出当次请求的回复消息，将Object类型的消息，格式化为String,List等具体类型，如果回复消息有Error则以异常的形式抛出。</p>
<h5 id="Pipeline和Transaction模式"><a href="#Pipeline和Transaction模式" class="headerlink" title="Pipeline和Transaction模式"></a>Pipeline和Transaction模式</h5><p>Transaction和Pipeline两个类的的类结构。可以看到Pipeline和Transaction都继承自<code>MultiKeyPipelineBase</code>，其中，<code>MultiKeyPipelineBase</code>和<code>PipelineBase</code>的区别在于处理的命令不同，内部均调用Client发送命令。</p>
<p>从以下用例也可以看出两者的操作也十分类似。Pipeline有一个内部类对象<code>MultiResponseBuilder</code>，前文提到，当Redis事务结束时，会以List的形式，一次性返回所有命令的执行结果。<code>MultiResponseBuilder</code>对象就是用于，当Pipeline开始其实模式后，在事务结束时，存储所有返回结果。</p>
<p>Queable用一个LinkedList装入每个命令的返回结果，<code>Response</code>是一个泛型，<code>set(Object data)</code>方法传入格式化之前的结果，<code>get()</code>方法返回格式化之后的结果。</p>
<p>Pipeline的使用方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Pipeline p = jedis.pipelined();</span><br><span class="line"><span class="comment">//只发送命令，不读取结果，此时的Response&lt;T&gt;没有数据</span></span><br><span class="line">Response&lt;String&gt; string = p.get(<span class="string">&quot;string&quot;</span>);</span><br><span class="line">Response&lt;String&gt; list = p.lpop(<span class="string">&quot;list&quot;</span>);</span><br><span class="line">Response&lt;String&gt; hash = p.hget(<span class="string">&quot;hash&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">Response&lt;Set&lt;String&gt;&gt; zset = p.zrange(<span class="string">&quot;zset&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">Response&lt;String&gt; set = p.spop(<span class="string">&quot;set&quot;</span>);</span><br><span class="line"><span class="comment">//一次读取所有response.此时的Response&lt;T&gt;有数据</span></span><br><span class="line">p.sync();</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="string">&quot;foo&quot;</span>, string.get());</span><br><span class="line">assertEquals(<span class="string">&quot;foo&quot;</span>, list.get());</span><br><span class="line">assertEquals(<span class="string">&quot;bar&quot;</span>, hash.get());</span><br><span class="line">assertEquals(<span class="string">&quot;foo&quot;</span>, zset.get().iterator().next());</span><br><span class="line">assertEquals(<span class="string">&quot;foo&quot;</span>, set.get());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Transactions使用方法：</span></span><br><span class="line"><span class="comment">//开启事务</span></span><br><span class="line">Transaction t = jedis.multi();</span><br><span class="line"><span class="comment">//命令进入服务端的待执行队列</span></span><br><span class="line">Response&lt;String&gt; string = t.get(<span class="string">&quot;string&quot;</span>);</span><br><span class="line">Response&lt;String&gt; list = t.lpop(<span class="string">&quot;list&quot;</span>);</span><br><span class="line">Response&lt;String&gt; hash = t.hget(<span class="string">&quot;hash&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">Response&lt;Set&lt;String&gt;&gt; zset = t.zrange(<span class="string">&quot;zset&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">Response&lt;String&gt; set = t.spop(<span class="string">&quot;set&quot;</span>);</span><br><span class="line"><span class="comment">//发送EXEC指令，执行所有命令，并返回结果</span></span><br><span class="line">t.exec();</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="string">&quot;foo&quot;</span>, string.get());</span><br><span class="line">assertEquals(<span class="string">&quot;foo&quot;</span>, list.get());</span><br><span class="line">assertEquals(<span class="string">&quot;bar&quot;</span>, hash.get());</span><br><span class="line">assertEquals(<span class="string">&quot;foo&quot;</span>, zset.get().iterator().next());</span><br><span class="line">assertEquals(<span class="string">&quot;foo&quot;</span>, set.get());</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbywxU.png" alt="MbywxU.png"></p>
<p>Pipeline的调用流程:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/Mb6kWV.png" alt="Mb6kWV.png"></p>
<p>Pipeline从发送请求到读取回复的具体实现，Transaction的实现与其类似，因而没有另外做图说明。由上图可见，Pipeline通过Client发送命令，Client在<code>sendCommand</code>时，会同时执行<code>pipelinedCommands++</code>，记录发送命令的条数（参见图3-5）。之后，返回一个<code>Response</code>实例，并将这个实例塞入了<code>pipelinedResponses</code>队列中。<code>Response</code>主要有3个属性：</p>
<ol>
<li>格式化前的回复消息data,</li>
<li>格式化后的回复消息response,</li>
<li>格式化方式builder。</li>
</ol>
<p> 刚发送消息后，<code>Response</code>里面的<code>data</code>和<code>response</code>是空值，只有格式化的方式<code>builder</code>。<code>Sync()</code>用于一次性读取所有回复，首先调用client的<code>getAll()</code>方法，<code>getAll()</code>方法根据之前记录的<code>pipelinedCommands</code>和Redis通讯协议，读取相同条数的回复消息到一个List，并返回给Pipeline。随后遍历这个List,逐个将回复消息赋给<code>pipelinedResponses</code>中每个<code>Response</code>的<code>data</code>。</p>
<p> 在执行<code>Response.get()</code>命令时，<code>Response</code>里面<code>data</code>已经有值了，但是是Object类型的，因而还要调用<code>build()</code>方法，做一次数据转换，返回格式化之后的数据。</p>
<p>以上就是Pipeline的主要工作流程。Transaction的<code>exec()</code>方法和<code>sync()</code>很相似，下文为<code>exec()</code>的具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">exec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 清空inputstream里面的所有数据，忽略QUEUED or ERROR回复</span></span><br><span class="line">  client.getMany(getPipelinedResponseLength());</span><br><span class="line">  <span class="comment">//发送EXEC指令，让服务端执行所有命令</span></span><br><span class="line">  client.exec();</span><br><span class="line">  <span class="comment">//事务结束</span></span><br><span class="line">  inTransaction = <span class="keyword">false</span>;</span><br><span class="line">  <span class="comment">//从inputStream中读取所有回复</span></span><br><span class="line">  List&lt;Object&gt; unformatted = client.getObjectMultiBulkReply();</span><br><span class="line">  <span class="keyword">if</span> (unformatted == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//和sync（）一样</span></span><br><span class="line">  List&lt;Object&gt; formatted = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</span><br><span class="line">  <span class="keyword">for</span> (Object o : unformatted) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">     formatted.add(generateResponse(o).get());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JedisDataException e) &#123;</span><br><span class="line">    formatted.add(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> formatted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="JedisCluster"><a href="#JedisCluster" class="headerlink" title="JedisCluster"></a>JedisCluster</h4><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbIo5D.png" alt="MbIo5D.png"></p>
<p>由于Jedis本身不是线程安全的，所以选择使用对象池JedisPool 来保证线程安全。在<code>JedisClusterInfoCache</code>中，除了要保存节点和槽的一一对应关系，还要为每个节点建立一个对象池<code>JedisPool</code>，并保存在<code>map</code>中。因而，这个类主要用于保存集群的配置信息，并且是JedisCluster初始化部分的核心所在。</p>
<p><code>JedisClusterConnectionHandler</code>是cache类的一个窗口，cache类似数据管理层，而Handler就类似于操控数据提供服务的Service层。</p>
<p><strong>初始化</strong></p>
<p>初始化调用时序图：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbIH8H.png" alt="MbIH8H.png"></p>
<p>初始化详情：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbokMn.png" alt="MbokMn.png"></p>
<p>Jedis建立集群的过程很清晰，传入节点信息，通过其中一个节点从redis服务器拿到整个集群的信息信息，包括槽位对应关系，主从节点的信息，保存在JedisClusterInfoCache中。</p>
<p><strong>调用流程</strong></p>
<p>使用方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;HostAndPort&gt; jedisClusterNode = <span class="keyword">new</span> HashSet&lt;HostAndPort&gt;();</span><br><span class="line">jedisClusterNode.add(<span class="keyword">new</span> HostAndPort(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">7379</span>));</span><br><span class="line">JedisCluster jc = <span class="keyword">new</span> JedisCluster(jedisClusterNode, DEFAULT_TIMEOUT, DEFAULT_TIMEOUT,</span><br><span class="line">    DEFAULT_REDIRECTIONS, <span class="string">&quot;cluster&quot;</span>, DEFAULT_CONFIG);</span><br><span class="line">jc.set(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">assertEquals(<span class="string">&quot;bar&quot;</span>, jc.get(<span class="string">&quot;foo&quot;</span>));</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MboMRJ.png" alt="MboMRJ.png"></p>
<p>具体实现过程：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbotIO.png" alt="MbotIO.png"></p>
<p>在发送请求时，JedisCluster对象先从初始化得到的集群map中获取key对应的节点连接，即一个可用的Jedis对象。然后通过这个对象发送<code>get key</code> 命令。</p>
<p>通常，根据key计算槽位得到的节点不会报错。所以如果发生<code>connectionException</code>,或者<code>MovedDataException</code>,说明初始化得到的槽位与节点的对应关系有问题，即与实际的对应关系不符，应当重置map。 如果出现ASK异常，说明数据正在迁移，需要临时使用返回消息指定的地址，重新发送命令。在这里，Jedis通过异常反馈，智能地同步了客户端与服务端的集群信息。</p>
<h4 id="JedisSentinel"><a href="#JedisSentinel" class="headerlink" title="JedisSentinel"></a>JedisSentinel</h4><p>JedisSentinel常用方式有两种：</p>
<ol>
<li><p>使用哨兵单节点拿到主节点，从节点的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过哨兵节点的信息新建Jedis实例，然后拿到Master节点的信息</span></span><br><span class="line">Jedis j = <span class="keyword">new</span> Jedis(sentinel);</span><br><span class="line">List&lt;Map&lt;String, String&gt;&gt; masters = j.sentinelMasters();</span><br><span class="line"><span class="comment">//拿到master的address，**MASTER_NAME**</span></span><br><span class="line">List&lt;String&gt; masterHostAndPort = j.sentinelGetMasterAddrByName(**MASTER_NAME**);</span><br><span class="line">HostAndPort masterFromSentinel = <span class="keyword">new</span> HostAndPort(masterHostAndPort.get(<span class="number">0</span>),Integer.parseInt(masterHostAndPort.get(<span class="number">1</span>)));</span><br><span class="line">assertEquals(master, masterFromSentinel);</span><br><span class="line"><span class="comment">//通过哨兵节点，拿到从节点的信息</span></span><br><span class="line">List&lt;Map&lt;String, String&gt;&gt; slaves = j.sentinelSlaves(**MASTER_NAME**);</span><br></pre></td></tr></table></figure></li>
<li><p>使用哨兵节点对象池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;String&gt; sentinels = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">sentinels.add(<span class="keyword">new</span> HostAndPort(<span class="string">&quot;localhost&quot;</span>, <span class="number">65432</span>).toString());</span><br><span class="line">sentinels.add(<span class="keyword">new</span> HostAndPort(<span class="string">&quot;localhost&quot;</span>, <span class="number">65431</span>).toString());</span><br><span class="line">JedisSentinelPool pool = <span class="keyword">new</span> JedisSentinelPool(MASTER_NAME, sentinels);</span><br><span class="line">pool.destroy();</span><br></pre></td></tr></table></figure></li>
</ol>
<p> <code>JedisSentinelPool</code>的结构清晰，内部使用对象池存放一个个<code>sentinel</code>实例。下图分别为<code>JedisSentinelPool</code>的类结构和初始化流程。在使用时，我们先根据，host,port等信息，初始化一个Jedis实例，然后可以通过<code>sentinelMasters()</code>，<code>sentinelGetMasterAddrByName(MASTER_NAME)</code>，<code>sentinelSlaves(MASTER_NAME)</code>等方法拿到这个哨兵节点监听的MASTER节点信息或对应的SLAVE节点信息。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MboyeP.png" alt="MboyeP.png"></p>
<p>初始化流程：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/Mbo2FS.png" alt="Mbo2FS.png"></p>
<h4 id="ShardedJedis"><a href="#ShardedJedis" class="headerlink" title="ShardedJedis"></a>ShardedJedis</h4><p>构建Jedis分片的方法（单节点与对象池的模式）</p>
<ol>
<li><p>单节点模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">List&lt;JedisShardInfo&gt; shards = <span class="keyword">new</span> ArrayList&lt;JedisShardInfo&gt;(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//其中一个分片</span></span><br><span class="line">JedisShardInfo shard1 = <span class="keyword">new</span> JedisShardInfo(redis1);</span><br><span class="line">shards.add(shard1);</span><br><span class="line"><span class="comment">//另一个分片</span></span><br><span class="line">JedisShardInfo shard2 = <span class="keyword">new</span> JedisShardInfo(redis2);</span><br><span class="line">shards.add(shard2);</span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;resource&quot;)</span></span><br><span class="line"><span class="comment">//新建ShardedJedis实例</span></span><br><span class="line">ShardedJedis shardedJedis = <span class="keyword">new</span> ShardedJedis(shards);</span><br><span class="line">shardedJedis.set(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"><span class="comment">//通过key可以查看存储在哪个jedis</span></span><br><span class="line">JedisShardInfo ak = shardedJedis.getShardInfo(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">assertEquals(shard2, ak);</span><br></pre></td></tr></table></figure></li>
<li><p>对象池模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ShardedJedisPool pool = <span class="keyword">new</span> ShardedJedisPool(<span class="keyword">new</span> GenericObjectPoolConfig(), shards);</span><br><span class="line">ShardedJedis jedis = pool.getResource();</span><br><span class="line">jedis.set(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">assertEquals(<span class="string">&quot;bar&quot;</span>, jedis.get(<span class="string">&quot;foo&quot;</span>));</span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbTeOI.png" alt="MbTeOI.png"></p>
<p>初始化流程：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/23/MbTQk8.png" alt="MbTQk8.png"></p>
<p>ShardedJedis的类结构（其内部保存一个对象池，与常规的JedisPool的不同之处在于，内部的<code>PooledObjectFactory</code>实现不同）,分片信息保存在基类<code>Sharded</code>中，<code>Sharded</code>保存了3个重要变量：</p>
<ol>
<li>nodes是一个TreeMap,保存了每个分片节点和对应的hash值。</li>
<li>algo是计算hash值的函数，默认是MurmurHash,可替换。</li>
<li>resources是一个LinkedHashMap，存放着JedisShardinfo和一个Jedis实例的对应关系。</li>
</ol>
<p> <code>ShardedJedis</code>的初始化流程，通过传入待分片的节点信息，初始化好上述3个变量。在使用时，先根据key计算出hash值，在<code>nodes</code>中找到对应的分片信息，再在<code>resources</code>中找到对应的Jedis实例，然后通过这个Jedis实例才操作redis节点。</p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><ol>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000013052104">Jedis源码分析（一）-Jedis介绍</a></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">平心</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://pingxin0521.gitee.io/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-1-3/">https://pingxin0521.gitee.io/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-1-3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://pingxin0521.gitee.io" target="_blank">平心de小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="post-meta__tags" href="/tags/NoSQL/">NoSQL</a><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-1-4/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis 事务、发布订阅</div></div></a></div><div class="next-post pull-right"><a href="/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-2-2/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis 主从复制</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/10/18/数据库-Redis-1-4/" title="Redis 事务、发布订阅"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-11-24</div><div class="title">Redis 事务、发布订阅</div></div></a></div><div><a href="/2019/10/19/数据库-Redis-1-5/" title="Redis 高级类型"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/okfOw28KlZFbE7z.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-14</div><div class="title">Redis 高级类型</div></div></a></div><div><a href="/2020/02/14/数据库-Redis-1-6/" title="Redis 应用场景示例"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-14</div><div class="title">Redis 应用场景示例</div></div></a></div><div><a href="/2019/08/18/数据库-Redis-1-1/" title="Redis 数据结构"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-14</div><div class="title">Redis 数据结构</div></div></a></div><div><a href="/2019/06/18/数据库-Redis-1-0/" title="Redis入门和安装"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-14</div><div class="title">Redis入门和安装</div></div></a></div><div><a href="/2019/09/08/数据库-Redis-1-2/" title="Redis 设计和示例"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-11-23</div><div class="title">Redis 设计和示例</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/02/11/1ovw6J.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">平心</div><div class="author-info__description">年轻人的life、learn and think</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">449</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">77</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">68</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hanyunpeng0521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hanyunpeng0521" target="_blank" title="Github"><i class="fa fa-github"></i></a><a class="social-icon" href="mailto:m13839441583@163.com" target="_blank" title="Email"><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">为什么呢？开始提问吧</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E5%8D%8F%E8%AE%AE%E8%A7%84%E8%8C%83%EF%BC%88Redis-Protocol-specification%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">redis协议规范（Redis Protocol specification）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jedis%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">Jedis使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Jedis%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.1.</span> <span class="toc-text">Jedis对象</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Jedis%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.1.</span> <span class="toc-text">Jedis的初始化流程</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JedisPool"><span class="toc-number">2.2.</span> <span class="toc-text">JedisPool</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JedisPool%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.2.1.</span> <span class="toc-text">JedisPool初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jedis%E8%BF%9E%E6%8E%A5%E8%8E%B7%E5%8F%96"><span class="toc-number">2.2.2.</span> <span class="toc-text">Jedis连接获取</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jedis%E8%BF%9E%E6%8E%A5%E5%85%B3%E9%97%AD"><span class="toc-number">2.2.3.</span> <span class="toc-text">Jedis连接关闭</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jedis%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E7%9A%84%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">Jedis工作模式的调用流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#client%E8%AF%B7%E6%B1%82%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.1.</span> <span class="toc-text">client请求模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pipeline%E5%92%8CTransaction%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.2.</span> <span class="toc-text">Pipeline和Transaction模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JedisCluster"><span class="toc-number">2.4.</span> <span class="toc-text">JedisCluster</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JedisSentinel"><span class="toc-number">2.5.</span> <span class="toc-text">JedisSentinel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ShardedJedis"><span class="toc-number">2.6.</span> <span class="toc-text">ShardedJedis</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">参考：</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/05/15/node-2-4/" title="Egg.js -- 为企业级框架和应用而生"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/okfOw28KlZFbE7z.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Egg.js -- 为企业级框架和应用而生"/></a><div class="content"><a class="title" href="/2021/05/15/node-2-4/" title="Egg.js -- 为企业级框架和应用而生">Egg.js -- 为企业级框架和应用而生</a><time datetime="2021-05-15T10:18:59.000Z" title="发表于 2021-05-15 18:18:59">2021-05-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/30/node-2-3/" title="Koa -- 基于Node.js平台的下一代Web开发框架"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koa -- 基于Node.js平台的下一代Web开发框架"/></a><div class="content"><a class="title" href="/2021/04/30/node-2-3/" title="Koa -- 基于Node.js平台的下一代Web开发框架">Koa -- 基于Node.js平台的下一代Web开发框架</a><time datetime="2021-04-30T10:18:59.000Z" title="发表于 2021-04-30 18:18:59">2021-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/01/node-2-1/" title="Node.JS web开发前置知识"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Node.JS web开发前置知识"/></a><div class="content"><a class="title" href="/2021/04/01/node-2-1/" title="Node.JS web开发前置知识">Node.JS web开发前置知识</a><time datetime="2021-04-01T03:18:59.000Z" title="发表于 2021-04-01 11:18:59">2021-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-1/" title="第十一周--谷歌浏览器插件"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第十一周--谷歌浏览器插件"/></a><div class="content"><a class="title" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-1/" title="第十一周--谷歌浏览器插件">第十一周--谷歌浏览器插件</a><time datetime="2020-12-26T10:18:59.000Z" title="发表于 2020-12-26 18:18:59">2020-12-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-0/" title="第十一周--浏览器技术"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第十一周--浏览器技术"/></a><div class="content"><a class="title" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-0/" title="第十一周--浏览器技术">第十一周--浏览器技术</a><time datetime="2020-12-26T06:18:59.000Z" title="发表于 2020-12-26 14:18:59">2020-12-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By 平心</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '4lfIXzqxaC1ONs0MJO4oHu07-gzGzoHsz',
      appKey: 'qw99Bw8FD0KVKU9m457CwWsr',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>