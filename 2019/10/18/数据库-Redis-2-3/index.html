<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Redis 哨兵模式 | 平心de小屋</title><meta name="keywords" content="数据库,NoSQL,Redis"><meta name="author" content="平心"><meta name="copyright" content="平心"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Sentinel（哨兵模式）Sentinel(哨兵)是用于监控redis集群中Master状态的工具，其已经被集成在redis2.4+的版本中">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 哨兵模式">
<meta property="og:url" content="https://pingxin0521.gitee.io/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-2-3/index.html">
<meta property="og:site_name" content="平心de小屋">
<meta property="og:description" content="Sentinel（哨兵模式）Sentinel(哨兵)是用于监控redis集群中Master状态的工具，其已经被集成在redis2.4+的版本中">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg">
<meta property="article:published_time" content="2019-10-18T12:18:59.000Z">
<meta property="article:modified_time" content="2020-02-14T12:00:15.947Z">
<meta property="article:author" content="平心">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="NoSQL">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg"><link rel="shortcut icon" href="https://s2.ax1x.com/2020/02/11/1ovFOA.png"><link rel="canonical" href="https://pingxin0521.gitee.io/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-2-3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis 哨兵模式',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-02-14 20:00:15'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/02/11/1ovw6J.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">449</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">77</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">68</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">平心de小屋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis 哨兵模式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-10-18T12:18:59.000Z" title="发表于 2019-10-18 20:18:59">2019-10-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-02-14T12:00:15.947Z" title="更新于 2020-02-14 20:00:15">2020-02-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/NoSQL/">NoSQL</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/NoSQL/Redis/">Redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>30分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis 哨兵模式"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="Sentinel（哨兵模式）"><a href="#Sentinel（哨兵模式）" class="headerlink" title="Sentinel（哨兵模式）"></a>Sentinel（哨兵模式）</h3><p>Sentinel(哨兵)是用于监控redis集群中Master状态的工具，其已经被集成在redis2.4+的版本中</p>
<span id="more"></span>

<h4 id="主从复制的缺点"><a href="#主从复制的缺点" class="headerlink" title="主从复制的缺点"></a>主从复制的缺点</h4><p>首先回顾一下主从复制，主要有两个作用，第一为主节点提供数据备份，当主节点宕机时，从节点会有数据的完整副本。第二个就是为主节点提供读的分流，实现读写分离，可以减轻主节点的压力。</p>
<p>但是呢单使用主从复制模型会存在以下问题：</p>
<ol>
<li>手动故障转移<br>就是一旦主节点出现故障，那么故障转移基本上是需要手工来完成的。</li>
<li>写能力和存储能力受限<br>写只能写在一个节点上，而且存储也是在一个节点上进行存储。</li>
</ol>
<p><strong>主从复制-master宕掉</strong></p>
<p>一主两从模型，当master发生宕机时，那么复制也必然断掉了，而从节点与主节点的连接肯定也是失败的，这样数据的读取是正常的，但是数据的更新就无法保障了。</p>
<p><strong>主从复制-master宕掉故障处理</strong></p>
<p>首先要选择一个slave执行命令 <code>slave no one</code>，使其成为master节点。然后对其余的slave执行 <code>slaveof new master</code>，这样就完成了新的master节点以及其从节点的构建过程。同时需要让客户端的写操作在新的master上进行。</p>
<p>整个过程都是完全手工进行的，即使不手工而采用编写脚本的方式，让脚本不断监控master是否有问题，有问题之后选择一个新的master，然后让其他的slave都指向新的master节点，最后再去迁移所有的客户端。单独写这么一个完美的组件，也是非常困难的。</p>
<p>为了弥补主从模型在高可用方面的不足，Redis为我们提供了 <code>Redis Sentinel</code> 这样一个高可用的实现。</p>
<h4 id="Redis-Sentinel架构"><a href="#Redis-Sentinel架构" class="headerlink" title="Redis Sentinel架构"></a>Redis Sentinel架构</h4><p>Redis Sentinel 是一个分布式系统， 你可以在一个架构中运行多个 Sentinel 进程（progress）， 这些进程使用流言协议（gossip protocols)来接收关于主服务器是否下线的信息， 并使用投票协议（agreement protocols）来决定是否执行自动故障迁移， 以及选择哪个从服务器作为新的主服务器。</p>
<p>虽然 Redis Sentinel 释出为一个单独的可执行文件 redis-sentinel ， 但实际上它只是一个运行在特殊模式下的 Redis 服务器， 你可以在启动一个普通 Redis 服务器时通过给定 –sentinel 选项来启动 Redis Sentinel 。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/Qk7vTI.png" alt="Qk7vTI.png"></p>
<p><strong>Sentinel作用</strong></p>
<ul>
<li>Master-Slave切换后，master_redis.conf、slave_redis.conf和sentinel.conf的内容都会发生改变，即master_redis.conf中会多一行slaveof的配置，sentinel.conf的监控目标会随之调换</li>
<li><strong>监控（Monitoring</strong>）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</li>
<li><strong>提醒（Notification）</strong>： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li>
<li><strong>自动故障迁移（Automatic failover）</strong>： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</li>
</ul>
<p><strong>Sentinel工作方式</strong></p>
<ol>
<li><p>每个Sentinel以每秒钟一次的频率向它所知的Master，Slave以及其他 Sentinel 实例发送一个 PING 命令</p>
</li>
<li><p>如果一个实例（instance）距离最后一次有效回复PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被 Sentinel 标记为主观下线</p>
</li>
<li><p>如果一个Master被标记为主观下线，则正在监视这个Master的所有 Sentinel 要以每秒一次的频率确认Master的确进入了主观下线状态。</p>
</li>
<li><p>当有足够数量的 Sentinel（大于等于配置文件指定的值）在指定的时间范围内确认Master的确进入了主观下线状态， 则Master会被标记为客观下线</p>
</li>
<li><p>在一般情况下， 每个 Sentinel 会以每 10 秒一次的频率向它已知的所有Master，Slave发送 INFO 命令</p>
</li>
<li><p>当Master被 Sentinel 标记为客观下线时，Sentinel 向下线的 Master 的所有 Slave 发送 INFO 命令的频率会从 10 秒一次改为每秒一次</p>
</li>
<li><p>若没有足够数量的 Sentinel 同意 Master 已经下线， Master 的客观下线状态就会被移除</p>
<p>若 Master 重新向 Sentinel 的 PING 命令返回有效回复， Master 的主观下线状态就会被移除</p>
</li>
</ol>
<p><strong>故障转移处理</strong></p>
<ol>
<li>多个sentinel发现并确认master有问题</li>
<li>选举出一个sentinel作为领导</li>
<li>选出一个slave作为master</li>
<li>通知其余slave成为新的master的slave</li>
<li>通知客户端主从变化</li>
<li>等待老的master复活成为新master的slave</li>
</ol>
<p><strong>主观下线和客观下线</strong></p>
<p>主观下线：Subjectively Down，简称 SDOWN，指的是当前 Sentinel 实例对某个redis服务器做出的下线判断。</p>
<p>客观下线：Objectively Down， 简称 ODOWN，指的是多个 Sentinel 实例在对Master Server做出 SDOWN 判断，并且通过 SENTINEL is-master-down-by-addr 命令互相交流之后，得出的Master Server下线判断，然后开启failover.</p>
<p>SDOWN适合于Master和Slave，只要一个 Sentinel 发现Master进入了ODOWN， 这个 Sentinel 就可能会被其他 Sentinel 推选出， 并对下线的主服务器执行自动故障迁移操作。</p>
<p>ODOWN只适用于Master，对于Slave的 Redis 实例，Sentinel 在将它们判断为下线前不需要进行协商，所以Slave的 Sentinel 永远不会达到ODOWN。</p>
<p>如果一个服务器没有在 master-down-after-milliseconds 选项所指定的时间内， 对向它发送 PING 命令的 Sentinel 返回一个有效回复（valid reply）， 那么 Sentinel 就会将这个服务器标记为主观下线。</p>
<p>服务器对 PING 命令的有效回复可以是以下三种回复的其中一种：</p>
<ul>
<li>返回 +PONG 。</li>
<li>返回 -LOADING 错误。</li>
<li>返回 -MASTERDOWN 错误。</li>
</ul>
<p>如果服务器返回除以上三种回复之外的其他回复， 又或者在指定时间内没有回复 PING 命令， 那么 Sentinel 认为服务器返回的回复无效（non-valid）。</p>
<p><strong>Sentinel的通信命令</strong></p>
<p><code>Sentinel</code> 节点连接一个 <code>Redis</code> 实例的时候，会创建 <code>cmd</code> 和 <code>pub/sub</code> 两个 <strong>连接</strong>。<code>Sentinel</code> 通过 <code>cmd</code> 连接给 <code>Redis</code> 发送命令，通过 <code>pub/sub</code> 连接到 <code>Redis</code> 实例上的其他 <code>Sentinel</code> 实例。</p>
<p><code>Sentinel</code> 与 <code>Redis</code> <strong>主节点</strong> 和 <strong>从节点</strong> 交互的命令，主要包括：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作 用</th>
</tr>
</thead>
<tbody><tr>
<td>PING</td>
<td><code>Sentinel</code> 向 <code>Redis</code> 节点发送 <code>PING</code> 命令，检查节点的状态</td>
</tr>
<tr>
<td>INFO</td>
<td><code>Sentinel</code> 向 <code>Redis</code> 节点发送 <code>INFO</code> 命令，获取它的 <strong>从节点信息</strong></td>
</tr>
<tr>
<td>PUBLISH</td>
<td><code>Sentinel</code> 向其监控的 <code>Redis</code> 节点 <code>__sentinel__:hello</code> 这个 <code>channel</code> 发布 <strong>自己的信息</strong> 及 <strong>主节点</strong> 相关的配置</td>
</tr>
<tr>
<td>SUBSCRIBE</td>
<td><code>Sentinel</code> 通过订阅 <code>Redis</code> <strong>主节点</strong> 和 <strong>从节点</strong> 的 <code>__sentinel__:hello</code> 这个 <code>channnel</code>，获取正在监控相同服务的其他 <code>Sentinel</code> 节点</td>
</tr>
</tbody></table>
<p><code>Sentinel</code> 与 <code>Sentinel</code> 交互的命令，主要包括：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>作 用</th>
</tr>
</thead>
<tbody><tr>
<td>PING</td>
<td><code>Sentinel</code> 向其他 <code>Sentinel</code> 节点发送 <code>PING</code> 命令，检查节点的状态</td>
</tr>
<tr>
<td>SENTINEL:is-master-down-by-addr</td>
<td>和其他 <code>Sentinel</code> 协商 <strong>主节点</strong> 的状态，如果 <strong>主节点</strong> 处于 <code>SDOWN</code> 状态，则投票自动选出新的 <strong>主节点</strong></td>
</tr>
</tbody></table>
<p><strong>Redis Sentinel的工作原理</strong></p>
<p>每个 <code>Sentinel</code> 节点都需要 <strong>定期执行</strong> 以下任务：</p>
<ul>
<li><p>每个 <code>Sentinel</code> 以 <strong>每秒钟</strong> 一次的频率，向它所知的 <strong>主服务器</strong>、<strong>从服务器</strong> 以及其他 <code>Sentinel</code> <strong>实例</strong> 发送一个 <code>PING</code> 命令。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/QkHAmj.png" alt="QkHAmj.png"></p>
</li>
<li><p>如果一个 <strong>实例</strong>（<code>instance</code>）距离 <strong>最后一次</strong> 有效回复 <code>PING</code> 命令的时间超过 <code>down-after-milliseconds</code> 所指定的值，那么这个实例会被 <code>Sentinel</code> 标记为 <strong>主观下线</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/QkHQcF.png" alt="QkHQcF.png"></p>
</li>
<li><p>如果一个 <strong>主服务器</strong> 被标记为 <strong>主观下线</strong>，那么正在 <strong>监视</strong> 这个 <strong>主服务器</strong> 的所有 <code>Sentinel</code> 节点，要以 <strong>每秒一次</strong> 的频率确认 <strong>主服务器</strong> 的确进入了 <strong>主观下线</strong> 状态。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/QkHa9K.png" alt="QkHa9K.png"></p>
</li>
<li><p>如果一个 <strong>主服务器</strong> 被标记为 <strong>主观下线</strong>，并且有 <strong>足够数量</strong> 的 <code>Sentinel</code>（至少要达到 <strong>配置文件</strong> 指定的数量）在指定的 <strong>时间范围</strong> 内同意这一判断，那么这个 <strong>主服务器</strong> 被标记为 <strong>客观下线</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/QkH0je.png" alt="QkH0je.png"></p>
</li>
<li><p>在一般情况下， 每个 <code>Sentinel</code> 会以每 <code>10</code> 秒一次的频率，向它已知的所有 <strong>主服务器</strong> 和 <strong>从服务器</strong> 发送 <code>INFO</code> 命令。当一个 <strong>主服务器</strong> 被 <code>Sentinel</code> 标记为 <strong>客观下线</strong> 时，<code>Sentinel</code> 向 <strong>下线主服务器</strong> 的所有 <strong>从服务器</strong> 发送 <code>INFO</code> 命令的频率，会从 <code>10</code> 秒一次改为 <strong>每秒一次</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/QkHcNt.png" alt="QkHcNt.png"></p>
</li>
<li><p><code>Sentinel</code> 和其他 <code>Sentinel</code> 协商 <strong>主节点</strong> 的状态，如果 <strong>主节点</strong> 处于 <code>SDOWN</code> 状态，则投票自动选出新的 <strong>主节点</strong>。将剩余的 <strong>从节点</strong> 指向 <strong>新的主节点</strong> 进行 <strong>数据复制</strong>。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/QkH7En.png" alt="QkH7En.png"></p>
</li>
<li><p>当没有足够数量的 <code>Sentinel</code> 同意 <strong>主服务器</strong> 下线时， <strong>主服务器</strong> 的 <strong>客观下线状态</strong> 就会被移除。当 <strong>主服务器</strong> 重新向 <code>Sentinel</code> 的 <code>PING</code> 命令返回 <strong>有效回复</strong> 时，<strong>主服务器</strong> 的 <strong>主观下线状态</strong> 就会被移除。</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/QkHLCV.png" alt="QkHLCV.png"></p>
</li>
</ul>
<blockquote>
<p>注意：一个有效的 <code>PING</code> 回复可以是：<code>+PONG</code>、<code>-LOADING</code> 或者 <code>-MASTERDOWN</code>。如果 <strong>服务器</strong> 返回除以上三种回复之外的其他回复，又或者在 <strong>指定时间</strong> 内没有回复 <code>PING</code> 命令， 那么 <code>Sentinel</code> 认为服务器返回的回复 <strong>无效</strong>（<code>non-valid</code>）。</p>
</blockquote>
<h4 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h4><p><strong>Redis Sentinel的部署须知</strong></p>
<ol>
<li>一个稳健的 <code>Redis Sentinel</code> 集群，应该使用至少 <strong>三个</strong> <code>Sentinel</code> 实例，并且保证讲这些实例放到 <strong>不同的机器</strong> 上，甚至不同的 <strong>物理区域</strong>。</li>
<li><code>Sentinel</code> 无法保证 <strong>强一致性</strong>。</li>
<li>常见的 <strong>客户端应用库</strong> 都支持 <code>Sentinel</code>。</li>
<li><code>Sentinel</code> 需要通过不断的 <strong>测试</strong> 和 <strong>观察</strong>，才能保证高可用。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/11/29/Qk7usH.png" alt="Qk7usH.png"></p>
<p><strong>步骤</strong></p>
<ol>
<li>配置开启主从节点</li>
<li>配置开启sentinel监控主节点。(sentinel是特殊的redis)</li>
<li>实际应该多机器</li>
<li>详细配置节点</li>
</ol>
<p><strong>配置文件解释</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 哨兵sentinel实例运行的端口，默认26379</span>  </span><br><span class="line">port 26379</span><br><span class="line"><span class="meta">#</span><span class="bash"> 哨兵sentinel的工作目录</span></span><br><span class="line">dir ./</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 哨兵sentinel监控的redis主节点的</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># ip：主机ip地址</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># port：哨兵端口号</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># master-name：可以自己命名的主节点名字（只能由字母A-z、数字0-9 、这三个字符&quot;.-_&quot;组成。）</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># quorum：当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了</span></span>  </span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span>  </span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当在Redis实例中开启了requirepass &lt;foobared&gt;，所有连接Redis实例的客户端都要提供密码。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span>  </span><br><span class="line">sentinel auth-pass mymaster 123456  </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定主节点应答哨兵sentinel的最大时间间隔，超过这个时间，哨兵主观上认为主节点下线，默认30秒</span>  </span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000  </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定了在发生failover主备切换时，最多可以有多少个slave同时对新的master进行同步。这个数字越小，完成failover所需的时间就越长；反之，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为1，来保证每次只有一个slave，处于不能处理命令请求的状态。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;</span></span><br><span class="line">sentinel parallel-syncs mymaster 1  </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 故障转移的超时时间failover-timeout，默认三分钟，可以用在以下这些方面：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 1. 同一个sentinel对同一个master两次failover之间的间隔时间。</span></span>  </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 2. 当一个slave从一个错误的master那里同步数据时开始，直到slave被纠正为从正确的master那里同步数据时结束。</span></span>  </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 3. 当想要取消一个正在进行的failover时所需要的时间。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来同步数据了</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span>  </span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本。一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于脚本的运行结果有以下规则：</span>  </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 1. 若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 2. 若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。</span></span>  </span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 3. 如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span>  </span><br><span class="line">sentinel notification-script mymaster /var/redis/notify.sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这个脚本应该是通用的，能被多次调用，不是针对性的。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span></span><br><span class="line">sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</span><br></pre></td></tr></table></figure>

<p><strong>节点划分</strong></p>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP地址</th>
<th>端口号</th>
</tr>
</thead>
<tbody><tr>
<td>Redis Master</td>
<td>172.16.91.88</td>
<td>6379</td>
</tr>
<tr>
<td>Redis Slave1</td>
<td>172.16.91.88</td>
<td>6380</td>
</tr>
<tr>
<td>Redis Slave2</td>
<td>172.16.91.88</td>
<td>6381</td>
</tr>
<tr>
<td>Redis Sentinel1</td>
<td>172.16.91.88</td>
<td>26379</td>
</tr>
<tr>
<td>Redis Sentinel2</td>
<td>172.16.91.88</td>
<td>26381</td>
</tr>
<tr>
<td>Redis Sentinel3</td>
<td>172.16.91.88</td>
<td>26382</td>
</tr>
</tbody></table>
<p>主从的配置参考上一篇文章</p>
<p><strong>配置文件</strong></p>
<p>指定监听Master(三个节点),监视上一章的主从</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vi ./conf/sentinel_26379.conf</span></span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">dir /tmp</span><br><span class="line">logfile &quot;redis_26379.log&quot;</span><br><span class="line">sentinel monitor mymaster 172.16.91.88 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 900000</span><br><span class="line"><span class="meta"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi ./conf/sentinel_26381.conf</span></span><br><span class="line">port 26381</span><br><span class="line">daemonize yes</span><br><span class="line">dir /tmp</span><br><span class="line">logfile &quot;redis_26381.log&quot;</span><br><span class="line">sentinel monitor mymaster 172.16.91.88 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 900000</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi ./conf/sentinel_26382.conf</span></span><br><span class="line">port 26382</span><br><span class="line">daemonize yes</span><br><span class="line">dir /tmp</span><br><span class="line">logfile &quot;redis_26382.log&quot;</span><br><span class="line">sentinel monitor mymaster 172.16.91.88 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 900000</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">上面配置文件说明如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###</span></span></span><br><span class="line">port 5000#sentinel</span><br><span class="line"><span class="meta">#</span><span class="bash">监听的端口</span></span><br><span class="line">sentinel monitor mymaster192.168.241.150 9400 2 </span><br><span class="line"><span class="meta">#</span><span class="bash">192.168.241.150是master redis的IP地址和端口，2是代表2个sentinel检测到异常，才判断是real fail. Mymaster主机组的名称可以随便定义</span></span><br><span class="line">sentinel down-after-millisecondsmymaster 30000      #指定sentinel监控到redis实例持续异常多长时间后，会判决其状态为down。若实际业务需要sentinel尽快判决出redis实例异常，则可适当配小,单位是毫秒</span><br><span class="line">sentinel can-failover mymaster yes                  #在sentinel检测到O_DOWN后，是否对这台redis启动failover机制</span><br><span class="line">sentinel parallel-syncs mymaster 1                  #执行故障转移时，最多可以有多少个从服务器同时对新的主服务器进行同步，这个数字越小，完成故障转移所需的时间就越长，但越大就意味着越多的从服务器因为复制而不可用。可以通过将这个值设为 1 来保证每次只有一个从服务器处于不能处理命令请求的状态。</span><br><span class="line">sentinel failover-timeout mymaster900000            #若sentinel在该配置值内未能完成failover操作（即故障时master/slave自动切换），则认为本次failover失败</span><br><span class="line">sentinel auth-pass master1rot@minunix              #当redis访问都需要密码的时候，即在redis.conf有配置requirepass项的时候，需要定义此项</span><br><span class="line">sentinel notification-script master1/data/scripts/send_mail.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">当sentinel触发时，切换主从状态时，需要执行的脚本。当主down的时候可以通知当事人,</span></span><br></pre></td></tr></table></figure>

<p>启动sentinel(三个节点)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ./bin/redis-sentinel ./conf/sentinel_26379.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ./bin/redis-sentinel ./conf/sentinel_26381.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ./bin/redis-sentinel ./conf/sentinel_26382.conf</span></span><br></pre></td></tr></table></figure>

<p>注意，必须使用redis-sentinel命令启动sentinel_26379.conf，虽然redis-sentinel是redis-server的软连接</p>
<p>启动sentinel后，查看sentinel_26379.conf、sentinel_26380.conf、sentinel_26381.conf.可发现配置文件会记录已经加入的集群节点,并且配置文件内容改变了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# cat ./conf/sentinel-26379.conf</span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">dir &quot;/tmp&quot;</span><br><span class="line">logfile &quot;redis_26382.log&quot;</span><br><span class="line">sentinel myid 50f35915257992b0439b1c9e0931dc5c3aec8619</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line">sentinel monitor mymaster 172.16.91.88 6379 2</span><br><span class="line">sentinel failover-timeout mymaster 900000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Generated by CONFIG REWRITE</span></span><br><span class="line">protected-mode no</span><br><span class="line">sentinel config-epoch mymaster 0</span><br><span class="line">sentinel leader-epoch mymaster 0</span><br><span class="line">sentinel known-replica mymaster 172.16.91.88 6381</span><br><span class="line">sentinel known-replica mymaster 172.16.91.88 6380</span><br><span class="line">sentinel known-sentinel mymaster 172.16.91.88 26381 f61d75e58716c42a927d9455ab8a58101dca15da</span><br><span class="line">sentinel known-sentinel mymaster 172.16.91.88 26382 c3d145dd8d1f2e677405c7fbeb08702928ac628c</span><br><span class="line">sentinel current-epoch 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost redis]# cat ./conf/sentinel_26381.conf    </span><br><span class="line">port 26381</span><br><span class="line">daemonize yes</span><br><span class="line">dir &quot;/tmp&quot;</span><br><span class="line">logfile &quot;redis_26381.log&quot;</span><br><span class="line">sentinel myid f61d75e58716c42a927d9455ab8a58101dca15da</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line">sentinel monitor mymaster 172.16.91.88 6379 2</span><br><span class="line">sentinel failover-timeout mymaster 900000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Generated by CONFIG REWRITE</span></span><br><span class="line">protected-mode no</span><br><span class="line">sentinel config-epoch mymaster 0</span><br><span class="line">sentinel leader-epoch mymaster 0</span><br><span class="line">sentinel known-replica mymaster 172.16.91.88 6380</span><br><span class="line">sentinel known-replica mymaster 172.16.91.88 6381</span><br><span class="line">sentinel known-sentinel mymaster 172.16.91.88 26379 50f35915257992b0439b1c9e0931dc5c3aec8619</span><br><span class="line">sentinel known-sentinel mymaster 172.16.91.88 26382 c3d145dd8d1f2e677405c7fbeb08702928ac628c</span><br><span class="line">sentinel current-epoch 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@localhost redis]# cat ./conf/sentinel_26382.conf</span><br><span class="line">port 26382</span><br><span class="line">daemonize yes</span><br><span class="line">dir &quot;/tmp&quot;</span><br><span class="line">logfile &quot;redis_26382.log&quot;</span><br><span class="line">sentinel myid c3d145dd8d1f2e677405c7fbeb08702928ac628c</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line">sentinel monitor mymaster 172.16.91.88 6379 2</span><br><span class="line">sentinel failover-timeout mymaster 900000</span><br><span class="line"><span class="meta">#</span><span class="bash"> Generated by CONFIG REWRITE</span></span><br><span class="line">protected-mode no</span><br><span class="line">sentinel config-epoch mymaster 0</span><br><span class="line">sentinel leader-epoch mymaster 0</span><br><span class="line">sentinel known-replica mymaster 172.16.91.88 6381</span><br><span class="line">sentinel known-replica mymaster 172.16.91.88 6380</span><br><span class="line">sentinel known-sentinel mymaster 172.16.91.88 26379 50f35915257992b0439b1c9e0931dc5c3aec8619</span><br><span class="line">sentinel known-sentinel mymaster 172.16.91.88 26381 f61d75e58716c42a927d9455ab8a58101dca15da</span><br><span class="line">sentinel current-epoch 0</span><br></pre></td></tr></table></figure>

<p>查看启动状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ps -ef | grep redis</span></span><br><span class="line">root     12978     1  0 13:57 ?        00:00:00 ./bin/redis-server 0.0.0.0:6379</span><br><span class="line">root     12983     1  0 13:57 ?        00:00:00 ./bin/redis-server 0.0.0.0:6380</span><br><span class="line">root     12989     1  0 13:57 ?        00:00:00 ./bin/redis-server 0.0.0.0:6381</span><br><span class="line">root     13012     1  0 14:03 ?        00:00:00 ./bin/redis-sentinel *:26379 [sentinel]</span><br><span class="line">root     13017     1  0 14:04 ?        00:00:00 ./bin/redis-sentinel *:26382 [sentinel]</span><br><span class="line">root     13037     1  0 14:05 ?        00:00:00 ./bin/redis-sentinel *:26381 [sentinel]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看集群状态:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./bin/redis-cli info replication</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=172.16.91.88,port=6380,state=online,offset=62594,lag=1</span><br><span class="line">slave1:ip=172.16.91.88,port=6381,state=online,offset=62594,lag=1</span><br><span class="line">master_replid:aaa2b9039913ed499d0274dd8a2106d22b9e85df</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:62733</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:62733</span><br></pre></td></tr></table></figure>

<p>查看sentinel状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">  ./bin/redis-cli -p 26379 info sentinel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=172.16.91.88:6379,slaves=2,sentinels=3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bin/redis-cli -p 26381 info sentinel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=172.16.91.88:6379,slaves=2,sentinels=3</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bin/redis-cli -p 26382 info sentinel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=mymaster,status=ok,address=172.16.91.88:6379,slaves=2,sentinels=3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <strong>Sentinel时客户端命令</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">显示被监控的所有 主节点 以及它们的状态。</span></span><br><span class="line">127.0.0.1:26379&gt; SENTINEL masters</span><br><span class="line">1)  1) &quot;name&quot;</span><br><span class="line">    2) &quot;mymaster&quot;</span><br><span class="line">    3) &quot;ip&quot;</span><br><span class="line">    4) &quot;172.16.91.88&quot;</span><br><span class="line">    5) &quot;port&quot;</span><br><span class="line">    6) &quot;6379&quot;</span><br><span class="line">    7) &quot;runid&quot;</span><br><span class="line">    8) &quot;540c2d779bad31c469c885f797b334536c0cd9fd&quot;</span><br><span class="line">    9) &quot;flags&quot;</span><br><span class="line">   10) &quot;master&quot;</span><br><span class="line">   11) &quot;link-pending-commands&quot;</span><br><span class="line">   12) &quot;0&quot;</span><br><span class="line">   13) &quot;link-refcount&quot;</span><br><span class="line">   14) &quot;1&quot;</span><br><span class="line">   15) &quot;last-ping-sent&quot;</span><br><span class="line">   16) &quot;0&quot;</span><br><span class="line">   17) &quot;last-ok-ping-reply&quot;</span><br><span class="line">   18) &quot;1052&quot;</span><br><span class="line">   19) &quot;last-ping-reply&quot;</span><br><span class="line">   20) &quot;1052&quot;</span><br><span class="line">   21) &quot;down-after-milliseconds&quot;</span><br><span class="line">   22) &quot;30000&quot;</span><br><span class="line">   23) &quot;info-refresh&quot;</span><br><span class="line">   24) &quot;7228&quot;</span><br><span class="line">   25) &quot;role-reported&quot;</span><br><span class="line">   26) &quot;master&quot;</span><br><span class="line">   27) &quot;role-reported-time&quot;</span><br><span class="line">   28) &quot;1653625&quot;</span><br><span class="line">   29) &quot;config-epoch&quot;</span><br><span class="line">   30) &quot;0&quot;</span><br><span class="line">   31) &quot;num-slaves&quot;</span><br><span class="line">   32) &quot;2&quot;</span><br><span class="line">   33) &quot;num-other-sentinels&quot;</span><br><span class="line">   34) &quot;2&quot;</span><br><span class="line">   35) &quot;quorum&quot;</span><br><span class="line">   36) &quot;2&quot;</span><br><span class="line">   37) &quot;failover-timeout&quot;</span><br><span class="line">   38) &quot;900000&quot;</span><br><span class="line">   39) &quot;parallel-syncs&quot;</span><br><span class="line">   40) &quot;1&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash">显示指定 主节点 的信息和状态。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt; SENTINEL master &lt;master_name&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">显示指定 主节点 的所有 从节点 以及它们的状态。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt; SENTINEL slaves &lt;master_name&gt;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:26379&gt; SENTINEL slaves  mymaster</span><br><span class="line">1)  1) &quot;name&quot;</span><br><span class="line">    2) &quot;172.16.91.88:6380&quot;</span><br><span class="line">    3) &quot;ip&quot;</span><br><span class="line">    4) &quot;172.16.91.88&quot;</span><br><span class="line">    5) &quot;port&quot;</span><br><span class="line">    6) &quot;6380&quot;</span><br><span class="line">    7) &quot;runid&quot;</span><br><span class="line">    8) &quot;1a7c6cdad51571419ba27626e365bdc1416996b3&quot;</span><br><span class="line">    9) &quot;flags&quot;</span><br><span class="line">   10) &quot;slave&quot;</span><br><span class="line">   11) &quot;link-pending-commands&quot;</span><br><span class="line">   12) &quot;0&quot;</span><br><span class="line">   13) &quot;link-refcount&quot;</span><br><span class="line">   14) &quot;1&quot;</span><br><span class="line">   15) &quot;last-ping-sent&quot;</span><br><span class="line">   16) &quot;0&quot;</span><br><span class="line">   17) &quot;last-ok-ping-reply&quot;</span><br><span class="line">   18) &quot;548&quot;</span><br><span class="line">   19) &quot;last-ping-reply&quot;</span><br><span class="line">   20) &quot;548&quot;</span><br><span class="line">   21) &quot;down-after-milliseconds&quot;</span><br><span class="line">   22) &quot;30000&quot;</span><br><span class="line">   23) &quot;info-refresh&quot;</span><br><span class="line">   24) &quot;4590&quot;</span><br><span class="line">   25) &quot;role-reported&quot;</span><br><span class="line">   26) &quot;slave&quot;</span><br><span class="line">   27) &quot;role-reported-time&quot;</span><br><span class="line">   28) &quot;2042636&quot;</span><br><span class="line">   29) &quot;master-link-down-time&quot;</span><br><span class="line">   30) &quot;0&quot;</span><br><span class="line">   31) &quot;master-link-status&quot;</span><br><span class="line">   32) &quot;ok&quot;</span><br><span class="line">   33) &quot;master-host&quot;</span><br><span class="line">   34) &quot;172.16.91.88&quot;</span><br><span class="line">   35) &quot;master-port&quot;</span><br><span class="line">   36) &quot;6379&quot;</span><br><span class="line">   37) &quot;slave-priority&quot;</span><br><span class="line">   38) &quot;100&quot;</span><br><span class="line">   39) &quot;slave-repl-offset&quot;</span><br><span class="line">   40) &quot;559168&quot;</span><br><span class="line">2)  1) &quot;name&quot;</span><br><span class="line">    2) &quot;172.16.91.88:6381&quot;</span><br><span class="line">    3) &quot;ip&quot;</span><br><span class="line">    4) &quot;172.16.91.88&quot;</span><br><span class="line">    5) &quot;port&quot;</span><br><span class="line">    6) &quot;6381&quot;</span><br><span class="line">    7) &quot;runid&quot;</span><br><span class="line">    8) &quot;defdc5aa58e6c1944688e1c585dc46f97773d2d2&quot;</span><br><span class="line">    9) &quot;flags&quot;</span><br><span class="line">   10) &quot;slave&quot;</span><br><span class="line">   11) &quot;link-pending-commands&quot;</span><br><span class="line">   12) &quot;0&quot;</span><br><span class="line">   13) &quot;link-refcount&quot;</span><br><span class="line">   14) &quot;1&quot;</span><br><span class="line">   15) &quot;last-ping-sent&quot;</span><br><span class="line">   16) &quot;0&quot;</span><br><span class="line">   17) &quot;last-ok-ping-reply&quot;</span><br><span class="line">   18) &quot;548&quot;</span><br><span class="line">   19) &quot;last-ping-reply&quot;</span><br><span class="line">   20) &quot;548&quot;</span><br><span class="line">   21) &quot;down-after-milliseconds&quot;</span><br><span class="line">   22) &quot;30000&quot;</span><br><span class="line">   23) &quot;info-refresh&quot;</span><br><span class="line">   24) &quot;4590&quot;</span><br><span class="line">   25) &quot;role-reported&quot;</span><br><span class="line">   26) &quot;slave&quot;</span><br><span class="line">   27) &quot;role-reported-time&quot;</span><br><span class="line">   28) &quot;2042636&quot;</span><br><span class="line">   29) &quot;master-link-down-time&quot;</span><br><span class="line">   30) &quot;0&quot;</span><br><span class="line">   31) &quot;master-link-status&quot;</span><br><span class="line">   32) &quot;ok&quot;</span><br><span class="line">   33) &quot;master-host&quot;</span><br><span class="line">   34) &quot;172.16.91.88&quot;</span><br><span class="line">   35) &quot;master-port&quot;</span><br><span class="line">   36) &quot;6379&quot;</span><br><span class="line">   37) &quot;slave-priority&quot;</span><br><span class="line">   38) &quot;100&quot;</span><br><span class="line">   39) &quot;slave-repl-offset&quot;</span><br><span class="line">   40) &quot;559168&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">返回指定 主节点 的 IP 地址和 端口。如果正在进行 failover 或者 failover 已经完成，将会显示被提升为 主节点 的 从节点 的 IP 地址和 端口。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt; SENTINEL get-master-addr-by-name &lt;master_name&gt;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:26379&gt; SENTINEL get-master-addr-by-name mymaster</span><br><span class="line">1) &quot;172.16.91.88&quot;</span><br><span class="line">2) &quot;6379&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">重置名字匹配该 正则表达式 的所有的 主节点 的状态信息，清除它之前的 状态信息，以及 从节点 的信息。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&gt; SENTINEL reset &lt;pattern&gt;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">强制当前 Sentinel 节点执行 failover，并且不需要得到其他 Sentinel 节点的同意。但是 failover 后会将 最新的配置 发送给其他 Sentinel 节点。</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">&gt;SENTINEL failover &lt;master_name&gt;</span>   </span><br></pre></td></tr></table></figure>

<h4 id="Redis-Sentinel故障切换与恢复"><a href="#Redis-Sentinel故障切换与恢复" class="headerlink" title="Redis Sentinel故障切换与恢复"></a>Redis Sentinel故障切换与恢复</h4><p> <strong>Redis CLI客户端跟踪</strong></p>
<p>上面的日志显示，<code>redis-16379</code> 节点为 <strong>主节点</strong>，它的进程 <code>ID</code> 为 <code>12978</code>。为了模拟 <code>Redis</code> 主节点故障，强制杀掉这个进程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kill -9 12978</span><br></pre></td></tr></table></figure>

<p>使用 <code>redis-cli</code> 客户端命令进入 <code>sentinel-26379</code> 节点，查看 <code>Redis</code> <strong>节点</strong> 的状态信息。</p>
<p>查看 <code>Redis</code> 主从集群的 <strong>主节点</strong> 信息。可以发现 <code>redis-6380</code> 晋升为 <strong>新的主节点</strong>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ./bin/redis-cli -p 26379</span></span><br><span class="line">127.0.0.1:26379&gt; SENTINEL masters</span><br><span class="line">1)  1) &quot;name&quot;</span><br><span class="line">    2) &quot;mymaster&quot;</span><br><span class="line">    3) &quot;ip&quot;</span><br><span class="line">    4) &quot;172.16.91.88&quot;</span><br><span class="line">    5) &quot;port&quot;</span><br><span class="line">    6) &quot;6380&quot;</span><br><span class="line">    7) &quot;runid&quot;</span><br><span class="line">    8) &quot;&quot;</span><br><span class="line">    9) &quot;flags&quot;</span><br><span class="line">   10) &quot;master,disconnected&quot;</span><br><span class="line">   11) &quot;link-pending-commands&quot;</span><br><span class="line">   12) &quot;3&quot;</span><br><span class="line">   13) &quot;link-refcount&quot;</span><br><span class="line">   14) &quot;1&quot;</span><br><span class="line">   15) &quot;last-ping-sent&quot;</span><br><span class="line">   16) &quot;59&quot;</span><br><span class="line">   17) &quot;last-ok-ping-reply&quot;</span><br><span class="line">   18) &quot;59&quot;</span><br><span class="line">   19) &quot;last-ping-reply&quot;</span><br><span class="line">   20) &quot;59&quot;</span><br><span class="line">   21) &quot;down-after-milliseconds&quot;</span><br><span class="line">   22) &quot;30000&quot;</span><br><span class="line">   23) &quot;info-refresh&quot;</span><br><span class="line">   24) &quot;36673&quot;</span><br><span class="line">   25) &quot;role-reported&quot;</span><br><span class="line">   26) &quot;master&quot;</span><br><span class="line">   27) &quot;role-reported-time&quot;</span><br><span class="line">   28) &quot;59&quot;</span><br><span class="line">   29) &quot;config-epoch&quot;</span><br><span class="line">   30) &quot;1&quot;</span><br><span class="line">   31) &quot;num-slaves&quot;</span><br><span class="line">   32) &quot;2&quot;</span><br><span class="line">   33) &quot;num-other-sentinels&quot;</span><br><span class="line">   34) &quot;2&quot;</span><br><span class="line">   35) &quot;quorum&quot;</span><br><span class="line">   36) &quot;2&quot;</span><br><span class="line">   37) &quot;failover-timeout&quot;</span><br><span class="line">   38) &quot;900000&quot;</span><br><span class="line">   39) &quot;parallel-syncs&quot;</span><br><span class="line">   40) &quot;1&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Redis Sentinel日志跟踪</strong></p>
<p>查看任意 <code>Sentinel</code> 节点的日志如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /tmp/redis_26382.log</span></span><br><span class="line">...</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.483 # +sdown master mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.535 # +odown master mymaster 172.16.91.88 6379 #quorum 2/2</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.535 # +new-epoch 1</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.535 # +try-failover master mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.538 # +vote-for-leader c3d145dd8d1f2e677405c7fbeb08702928ac628c 1</span><br><span class="line">13069:X 29 Nov 2019 15:00:49.540 # +new-epoch 1</span><br><span class="line">13069:X 29 Nov 2019 15:00:49.542 # +vote-for-leader c3d145dd8d1f2e677405c7fbeb08702928ac628c 1</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.542 # 50f35915257992b0439b1c9e0931dc5c3aec8619 voted for c3d145dd8d1f2e677405c7fbeb08702928ac628c 1</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.543 # f61d75e58716c42a927d9455ab8a58101dca15da voted for c3d145dd8d1f2e677405c7fbeb08702928ac628c 1</span><br><span class="line">13069:X 29 Nov 2019 15:00:49.553 # +sdown master mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.600 # +elected-leader master mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.600 # +failover-state-select-slave master mymaster 172.16.91.88 6379</span><br><span class="line">13069:X 29 Nov 2019 15:00:49.653 # +odown master mymaster 172.16.91.88 6379 #quorum 3/2</span><br><span class="line">13069:X 29 Nov 2019 15:00:49.653 # Next failover delay: I will not start a failover before Fri Nov 29 15:30:49 2019</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.701 # +selected-slave slave 172.16.91.88:6380 172.16.91.88 6380 @ mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.701 * +failover-state-send-slaveof-noone slave 172.16.91.88:6380 172.16.91.88 6380 @ mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:49.759 * +failover-state-wait-promotion slave 172.16.91.88:6380 172.16.91.88 6380 @ mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:50.334 # +promoted-slave slave 172.16.91.88:6380 172.16.91.88 6380 @ mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:50.334 # +failover-state-reconf-slaves master mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:50.397 * +slave-reconf-sent slave 172.16.91.88:6381 172.16.91.88 6381 @ mymaster 172.16.91.88 6379</span><br><span class="line">13069:X 29 Nov 2019 15:00:50.398 # +config-update-from sentinel c3d145dd8d1f2e677405c7fbeb08702928ac628c 172.16.91.88 26382 @ mymaster 172.16.91.88 6379</span><br><span class="line">13069:X 29 Nov 2019 15:00:50.398 # +switch-master mymaster 172.16.91.88 6379 172.16.91.88 6380</span><br><span class="line">13069:X 29 Nov 2019 15:00:50.398 * +slave slave 172.16.91.88:6381 172.16.91.88 6381 @ mymaster 172.16.91.88 6380</span><br><span class="line">13069:X 29 Nov 2019 15:00:50.398 * +slave slave 172.16.91.88:6379 172.16.91.88 6379 @ mymaster 172.16.91.88 6380</span><br><span class="line">13079:X 29 Nov 2019 15:00:50.608 # -odown master mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:51.364 * +slave-reconf-inprog slave 172.16.91.88:6381 172.16.91.88 6381 @ mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:51.364 * +slave-reconf-done slave 172.16.91.88:6381 172.16.91.88 6381 @ mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:51.426 # +failover-end master mymaster 172.16.91.88 6379</span><br><span class="line">13079:X 29 Nov 2019 15:00:51.427 # +switch-master mymaster 172.16.91.88 6379 172.16.91.88 6380</span><br><span class="line">13079:X 29 Nov 2019 15:00:51.427 * +slave slave 172.16.91.88:6381 172.16.91.88 6381 @ mymaster 172.16.91.88 6380</span><br><span class="line">13079:X 29 Nov 2019 15:00:51.427 * +slave slave 172.16.91.88:6379 172.16.91.88 6379 @ mymaster 172.16.91.88 6380</span><br><span class="line">13069:X 29 Nov 2019 15:01:20.420 # +sdown slave 172.16.91.88:6379 172.16.91.88 6379 @ mymaster 172.16.91.88 6380</span><br><span class="line">13079:X 29 Nov 2019 15:01:21.432 # +sdown slave 172.16.91.88:6379 172.16.91.88 6379 @ mymaster 172.16.91.88 6380</span><br></pre></td></tr></table></figure>

<p>分析日志，可以发现 <code>redis-6379</code> 节点先进入 <code>sdown</code> <strong>主观下线</strong> 状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">13079:X 29 Nov 2019 15:00:49.483 # +sdown master mymaster 172.16.91.88 6379</span><br></pre></td></tr></table></figure>

<p>哨兵检测到 <code>redis-6379</code> 出现故障，<code>Sentinel</code> 进入一个 <strong>新纪元</strong>，从 <code>0</code> 变为 <code>1</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">13079:X 29 Nov 2019 15:00:49.535 # +new-epoch 1</span><br></pre></td></tr></table></figure>

<p>三个 <code>Sentinel</code> 节点开始协商 <strong>主节点</strong> 的状态，判断其是否需要 <strong>客观下线</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">13069:X 29 Nov 2019 15:00:49.542 # +vote-for-leader c3d145dd8d1f2e677405c7fbeb08702928ac628c 1</span><br></pre></td></tr></table></figure>

<p>超过 <code>quorum</code> 个数的 <code>Sentinel</code> 节点认为 <strong>主节点</strong> 出现故障，<code>redis-6379</code> 节点进入 <strong>客观下线</strong> 状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">13069:X 29 Nov 2019 15:00:49.653 # +odown master mymaster 172.16.91.88 6379 #quorum 3/2</span><br></pre></td></tr></table></figure>

<p><code>Sentinal</code> 进行 <strong>自动故障切换</strong>，协商选定 <code>redis-6380</code> 节点作为新的 <strong>主节点</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">13079:X 29 Nov 2019 15:00:51.427 # +switch-master mymaster 172.16.91.88 6379 172.16.91.88 6380</span><br></pre></td></tr></table></figure>

<p><code>redis-36329</code> 节点和已经 <strong>客观下线</strong> 的 <code>redis-6379</code> 节点成为 <code>redis-6380</code> 的 <strong>从节点</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">13079:X 29 Nov 2019 15:00:51.427 * +slave slave 172.16.91.88:6381 172.16.91.88 6381 @ mymaster 172.16.91.88 6380</span><br><span class="line">13079:X 29 Nov 2019 15:00:51.427 * +slave slave 172.16.91.88:6379 172.16.91.88 6379 @ mymaster 172.16.91.88 6380</span><br></pre></td></tr></table></figure>

<p><strong>Redis的配置文件</strong></p>
<p>分别查看三个 <code>redis</code> 节点的配置文件，发生 <strong>主从切换</strong> 时 <code>redis.conf</code> 的配置会自动发生刷新。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat ./conf/master-6739.conf</span> </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">port 6379</span><br><span class="line">dir /tmp</span><br><span class="line">logfile &quot;6379.log&quot;</span><br><span class="line">dbfilename &quot;dump-6379.rdb&quot;</span><br><span class="line">daemonize yes</span><br><span class="line">rdbcompression yes</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat ./conf/slave-6380.conf</span> </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">port 6380</span><br><span class="line">dir &quot;/tmp&quot;</span><br><span class="line">logfile &quot;6380.log&quot;</span><br><span class="line">dbfilename &quot;dump-6380.rdb&quot;</span><br><span class="line">daemonize yes</span><br><span class="line">rdbcompression yes</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat ./conf/slave-6381.conf</span> </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">port 6381</span><br><span class="line">dir &quot;/tmp&quot;</span><br><span class="line">logfile &quot;6381.log&quot;</span><br><span class="line">dbfilename &quot;dump-6381.rdb&quot;</span><br><span class="line">daemonize yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">replicaof 172.16.91.88 6380</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>：<code>redis-6380</code> 节点 <code>slaveof</code> 配置被移除，晋升为 <strong>主节点</strong>。<code>redis-6379</code> 节点处于 <strong>宕机状态</strong>。<code>redis-6381</code> 的 <code>slaveof</code> 配置更新为 <code>127.0.0.1 redis-6380</code>，成为 <code>redis-6380</code> 的 <strong>从节点</strong>。</p>
<p>重启节点 <code>redis-6379</code>。待正常启动后，再次查看它的 <code>redis.conf</code> 文件，配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat ./conf/master-6739.conf</span> </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">port 6379</span><br><span class="line">dir &quot;/tmp&quot;</span><br><span class="line">logfile &quot;6379.log&quot;</span><br><span class="line">dbfilename &quot;dump-6379.rdb&quot;</span><br><span class="line">daemonize yes</span><br><span class="line">rdbcompression yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> Generated by CONFIG REWRITE</span></span><br><span class="line">replicaof 172.16.91.88 6380</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>节点 <code>redis-6379</code> 的配置文件新增一行 <code>replicaof</code> 配置属性，指向 <code>redis-6380</code>，即成为 <strong>新的主节点</strong> 的 <strong>从节点</strong>。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ded0fd07f0b8">Redis Sentinel</a></li>
<li><a target="_blank" rel="noopener" href="https://www.duoluosb.com/665.html">Redis集群redis主从自动切换Sentinel（哨兵模式）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.redis.cn/topics/sentinel.html">Redis 的 Sentinel 文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bingshu/p/9776610.html">冰叔带你了解Redis-哨兵模式和高可用集群解析</a></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">平心</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://pingxin0521.gitee.io/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-2-3/">https://pingxin0521.gitee.io/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-2-3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://pingxin0521.gitee.io" target="_blank">平心de小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="post-meta__tags" href="/tags/NoSQL/">NoSQL</a><a class="post-meta__tags" href="/tags/Redis/">Redis</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/10/18/%E6%95%B0%E6%8D%AE%E5%BA%93-Redis-2-2/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis 主从复制</div></div></a></div><div class="next-post pull-right"><a href="/2019/10/16/%E6%95%B0%E6%8D%AE%E5%BA%93-MySQL-12-2/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MySQL 复制--基于gtid（二）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/10/18/数据库-Redis-1-4/" title="Redis 事务、发布订阅"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-11-24</div><div class="title">Redis 事务、发布订阅</div></div></a></div><div><a href="/2019/10/19/数据库-Redis-1-5/" title="Redis 高级类型"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/okfOw28KlZFbE7z.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-14</div><div class="title">Redis 高级类型</div></div></a></div><div><a href="/2020/02/14/数据库-Redis-1-6/" title="Redis 应用场景示例"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-14</div><div class="title">Redis 应用场景示例</div></div></a></div><div><a href="/2019/08/18/数据库-Redis-1-1/" title="Redis 数据结构"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-14</div><div class="title">Redis 数据结构</div></div></a></div><div><a href="/2019/06/18/数据库-Redis-1-0/" title="Redis入门和安装"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-14</div><div class="title">Redis入门和安装</div></div></a></div><div><a href="/2019/09/08/数据库-Redis-1-2/" title="Redis 设计和示例"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-11-23</div><div class="title">Redis 设计和示例</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/02/11/1ovw6J.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">平心</div><div class="author-info__description">年轻人的life、learn and think</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">449</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">77</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">68</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hanyunpeng0521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hanyunpeng0521" target="_blank" title="Github"><i class="fa fa-github"></i></a><a class="social-icon" href="mailto:m13839441583@163.com" target="_blank" title="Email"><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">为什么呢？开始提问吧</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel%EF%BC%88%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">Sentinel（哨兵模式）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="toc-number">1.1.</span> <span class="toc-text">主从复制的缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-Sentinel%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">Redis Sentinel架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-Sentinel%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="toc-number">1.4.</span> <span class="toc-text">Redis Sentinel故障切换与恢复</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">2.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/05/15/node-2-4/" title="Egg.js -- 为企业级框架和应用而生"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/okfOw28KlZFbE7z.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Egg.js -- 为企业级框架和应用而生"/></a><div class="content"><a class="title" href="/2021/05/15/node-2-4/" title="Egg.js -- 为企业级框架和应用而生">Egg.js -- 为企业级框架和应用而生</a><time datetime="2021-05-15T10:18:59.000Z" title="发表于 2021-05-15 18:18:59">2021-05-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/30/node-2-3/" title="Koa -- 基于Node.js平台的下一代Web开发框架"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koa -- 基于Node.js平台的下一代Web开发框架"/></a><div class="content"><a class="title" href="/2021/04/30/node-2-3/" title="Koa -- 基于Node.js平台的下一代Web开发框架">Koa -- 基于Node.js平台的下一代Web开发框架</a><time datetime="2021-04-30T10:18:59.000Z" title="发表于 2021-04-30 18:18:59">2021-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/01/node-2-1/" title="Node.JS web开发前置知识"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Node.JS web开发前置知识"/></a><div class="content"><a class="title" href="/2021/04/01/node-2-1/" title="Node.JS web开发前置知识">Node.JS web开发前置知识</a><time datetime="2021-04-01T03:18:59.000Z" title="发表于 2021-04-01 11:18:59">2021-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-1/" title="第十一周--谷歌浏览器插件"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第十一周--谷歌浏览器插件"/></a><div class="content"><a class="title" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-1/" title="第十一周--谷歌浏览器插件">第十一周--谷歌浏览器插件</a><time datetime="2020-12-26T10:18:59.000Z" title="发表于 2020-12-26 18:18:59">2020-12-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-0/" title="第十一周--浏览器技术"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第十一周--浏览器技术"/></a><div class="content"><a class="title" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-0/" title="第十一周--浏览器技术">第十一周--浏览器技术</a><time datetime="2020-12-26T06:18:59.000Z" title="发表于 2020-12-26 14:18:59">2020-12-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By 平心</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '4lfIXzqxaC1ONs0MJO4oHu07-gzGzoHsz',
      appKey: 'qw99Bw8FD0KVKU9m457CwWsr',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>