<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>nginx 热部署、虚拟主机和日志 | 平心de小屋</title><meta name="keywords" content="服务器,Nginx"><meta name="author" content="平心"><meta name="copyright" content="平心"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="热部署nginx 支持热加载 热部署 ，在不打断用户请求的情况下更新版本">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx 热部署、虚拟主机和日志">
<meta property="og:url" content="https://pingxin0521.gitee.io/2019/08/21/%E6%9C%8D%E5%8A%A1%E5%99%A8-Nginx-2-1/index.html">
<meta property="og:site_name" content="平心de小屋">
<meta property="og:description" content="热部署nginx 支持热加载 热部署 ，在不打断用户请求的情况下更新版本">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg">
<meta property="article:published_time" content="2019-08-21T03:18:59.000Z">
<meta property="article:modified_time" content="2021-01-09T13:37:24.334Z">
<meta property="article:author" content="平心">
<meta property="article:tag" content="服务器">
<meta property="article:tag" content="Nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg"><link rel="shortcut icon" href="https://s2.ax1x.com/2020/02/11/1ovFOA.png"><link rel="canonical" href="https://pingxin0521.gitee.io/2019/08/21/%E6%9C%8D%E5%8A%A1%E5%99%A8-Nginx-2-1/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'nginx 热部署、虚拟主机和日志',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-01-09 21:37:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/02/11/1ovw6J.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">449</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">77</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">68</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">平心de小屋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">nginx 热部署、虚拟主机和日志</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-08-21T03:18:59.000Z" title="发表于 2019-08-21 11:18:59">2019-08-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-01-09T13:37:24.334Z" title="更新于 2021-01-09 21:37:24">2021-01-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/">Nginx</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="nginx 热部署、虚拟主机和日志"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h4 id="热部署"><a href="#热部署" class="headerlink" title="热部署"></a>热部署</h4><p>nginx 支持热加载 热部署 ，在不打断用户请求的情况下更新版本</p>
<span id="more"></span>

<p>Nginx 只所以出名，和它内部的精密设计有关。Nginx 采用了高度模块化的设计思路，并且内部的进程主要有两类，master 进程 和 worker 进程。其中 master 进程只有一个，worker 进程可以有多个。</p>
<p>worker 进程才是真正 working 的进程，才是真正处理请求的进程。worker 进程全部都是 master 进程的子进程。worker 进程是以普通用户的身份进行运行的，这样就可以极大增加程序的安全性。就算是万一有一个进程被劫持，那也不会有管理员权限。</p>
<p>nginx 的热部署和其并发模型有着密不可分的关系。说白了，就是因为 master 进程的关系。当通知 ngnix 重读配置文件的时候，master 进程会进行语法错误的判断。如果存在语法错误的话，返回错误，不进行装载；如果配置文件没有语法错误，那么 ngnix 也不会将新的配置调整到所有 worker 中。而是，先不改变已经建立连接的 worker，等待 worker 将所有请求结束之后，将原先在旧的配置下启动的 worker 杀死，然后使用新的配置创建新的 worker。</p>
<p><strong>实践</strong></p>
<p>假设有两个不同版本的nginx，一个正在运行，另一个则要替换正在运行的nginx。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装依赖项</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install -y pcre-devel zlib-devel gcc wget vim  make</span></span><br><span class="line"><span class="meta"> </span></span><br><span class="line"><span class="meta">#</span><span class="bash">低版本1.14.2</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span></span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://nginx.org/download/nginx-1.14.2.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar zxf nginx-1.14.2.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> nginx-1.14.2</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/opt/nginx --with-http_stub_status_module</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install</span></span><br><span class="line"><span class="meta">#</span><span class="bash">然后运行该nginx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> /opt/nginx/sbin/nginx -V</span></span><br><span class="line">nginx version: nginx/1.14.2</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class="line">configure arguments: --prefix=/opt/nginx --with-http_stub_status_module</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> /opt/nginx/sbin/nginx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef | grep nginx</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">高版本1.16.1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span></span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://nginx.org/download/nginx-1.16.1.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar zxf nginx-1.16.1.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> nginx-1.16.1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/opt/nginx --with-http_stub_status_module</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">备份旧版本的nginx的执行程序</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mv /opt/nginx/sbin/nginx /opt/nginx/sbin/nginx.old</span></span><br><span class="line"><span class="meta">#</span><span class="bash">替换旧的Nginx的执行程序</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp objs/nginx /opt/nginx/sbin/nginx</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> /opt/nginx/sbin/nginx -V</span></span><br><span class="line">nginx version: nginx/1.16.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class="line">configure arguments: --prefix=/opt/nginx --with-http_stub_status_module</span><br><span class="line"><span class="meta">#</span><span class="bash">命令替换完毕</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">平滑升级,更换worker进程</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef | grep nginx</span></span><br><span class="line">root      3897     1  0 07:38 ?        00:00:00 nginx: master process /opt/nginx/sbin/nginx</span><br><span class="line">nobody    3898  3897  0 07:38 ?        00:00:00 nginx: worker process</span><br><span class="line">root      6434    14  0 07:41 pts/1    00:00:00 grep --color=auto nginx</span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -USR2 `cat /opt/nginx/logs/nginx.pid`</span></span><br><span class="line"><span class="meta">#</span><span class="bash">发送USR2信号给旧版本主进程号,使nginx的旧版本停止接收请求，用nginx新版本接替，且老进程处理完所有请求，关闭所有连接后，停止</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef | grep nginx</span></span><br><span class="line">root      3897     1  0 07:38 ?        00:00:00 nginx: master process /opt/nginx/sbin/nginx</span><br><span class="line">nobody    3898  3897  0 07:38 ?        00:00:00 nginx: worker process</span><br><span class="line">root      6440  3897  0 07:42 ?        00:00:00 nginx: master process /opt/nginx/sbin/nginx</span><br><span class="line">nobody    6441  6440  0 07:42 ?        00:00:00 nginx: worker process</span><br><span class="line">root      6443    14  0 07:42 pts/1    00:00:00 grep --color=auto nginx</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">会发现目前系统中有2个nginx在运行，此时需要告诉 进程的nginx 优雅的关闭。</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -WINCH `cat /opt/nginx/logs/nginx.pid.oldbin`</span></span><br><span class="line"><span class="meta">#</span><span class="bash">这样nginx热部署就成功了</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef | grep nginx</span></span><br><span class="line">root      3897     1  0 07:38 ?        00:00:00 nginx: master process /opt/nginx/sbin/nginx</span><br><span class="line">root      6440  3897  0 07:42 ?        00:00:00 nginx: master process /opt/nginx/sbin/nginx</span><br><span class="line">nobody    6441  6440  0 07:42 ?        00:00:00 nginx: worker process</span><br><span class="line">root      6459    14  0 08:00 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<p>保留旧的 master 进程是为了在新的版本存在问题时，可以快速回退到原版本。<strong>如果发现问题要紧急回滚呢？</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mv /opt/nginx/sbin/nginx.old /opt/nginx/sbin/nginx -y</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拉起旧版本的worker进程（-HUP 相当于 -s reload）</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -HUP `cat /opt/nginx/logs/nginx.pid.oldbin`</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 让新版本的 worker 不再接受请求</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -USR2 `cat /opt/nginx/logs/nginx.pid`</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭新版本的 woker 进程</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -WINCH `cat /opt/nginx/logs/nginx.pid`</span></span><br></pre></td></tr></table></figure>

<p>如果确认无误要退出老版本的 nginx，可以执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -QUIT `cat /opt/nginx/logs/nginx.pid`</span></span><br><span class="line"><span class="meta">#</span><span class="bash">或者退出新版本</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -QUIT `cat /opt/nginx/logs/nginx.pid.oldbin`</span></span><br></pre></td></tr></table></figure>

<h4 id="静态资源Web服务器"><a href="#静态资源Web服务器" class="headerlink" title="静态资源Web服务器"></a>静态资源Web服务器</h4><p>有两种方法部署，一是将静态资源文件夹移到nginx的<code>/uar/share/nginx/html</code>文件夹下；另一个则是使用虚拟主机。</p>
<p>可以通过 nginx 进行虚拟主机的配置，只需要在 <code>http &#123;&#125;</code> 中添加一个 <code>server &#123;&#125;</code> 模块即可。nginx 虚拟主机的配置，一般分为三种：域名、端口和 ip。</p>
<p><strong>类型介绍</strong></p>
<ol>
<li><p>基于域名的虚拟主机</p>
<p>所谓基于域名的虚拟主机，意思就是通过不同的域名区分不同的虚拟主机，基于域名的虚拟主机是企业应用最广的虚拟主机类型，几乎所有对外提供服务的网站使用的都是基于域名的主机，例如<a target="_blank" rel="noopener" href="http://www.test1.com/">www.test1.com</a> <a target="_blank" rel="noopener" href="http://www.test2.com等/">www.test2.com等</a></p>
</li>
<li><p>基于端口的虚拟主机</p>
<p>同理，所谓基于端口的虚拟主机，意思就是通过不同的端口来区分不同的虚拟主机，此类虚拟主机对应的企业应用主要为公司内部的网站，例如：一些不希望直接对外提供用户访问的网站后台等，访问基于端口的虚拟主机，地址里要带有端口号，例如<a target="_blank" rel="noopener" href="http://www.test.com:81/">http://www.test.com:81</a> <a href="http://www.test.com:82等">http://www.test.com:82等</a></p>
</li>
<li><p>基于IP的虚拟主机</p>
<p>同理，所谓基于IP的虚拟主机，意思就是通过不同的IP区分不同的虚拟主机，此类虚拟主机对应的企业应用非常少见，一般不同的业务需要使用多IP的场景都会在负载均衡上进行IP绑定，我不是在web上绑定IP来区分不同的虚拟机。</p>
</li>
</ol>
<p>三种虚拟主机类型均可独立使用，也可以混合使用。</p>
<p><strong>基于多域名的虚拟主机配置</strong></p>
<p>基本步骤：修改nginx配置文件配置多域名，重启nginx服务，创建对应的不同站点目录并上传站点文件，也可都使用一个站点目录，通过多域名来访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	#server_name 指定虚拟主机的名字。可以指定多个名称，第一个为虚拟主机的名字。</span><br><span class="line">	#可以使用 “ * ” 替代服务器名称的开始或者最后部分。</span><br><span class="line">	server_name www.test1.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">#root 设置请求的根目录，可以用绝对路径或相对路径，如 root html; 会等于 root /usr/local/nginx/html; 。nginx安装目录为/usr/local/nginx/</span><br><span class="line">#而这样设置，当收到一个 domain.cm/index.html 请求时，/usr/local/nginx/html/index.html 文件将会被发送在响应中响应该请求。</span><br><span class="line">		root /usr/share/nginx/html/;</span><br><span class="line">#index 定义将用做索引的文件。文件名称可以包含变量，按照指定的顺序进行文件检查的，最后一个参数可以是绝对路径。</span><br><span class="line">#实际上 domain.cm 请求会被处理成 domain.cm/index.html 。</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name www.test2.com www.test3.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /usr/share/nginx/html/;</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name www.test4.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /data/html/;</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>基于多端口的虚拟主机配置</strong></p>
<p>基本步骤：修改nginx配置文件配置多端口，重启nginx服务，修改安全组规则开放端口，创建对应的不同站点目录并上传站点文件，也可都使用一个站点目录，通过多端口来访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">server &#123;</span><br><span class="line">	listen 81;</span><br><span class="line">	server_name www.test.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /usr/share/nginx/html/;</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 82;</span><br><span class="line">	server_name www.test.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /usr/share/nginx/html/;</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 83;</span><br><span class="line">	server_name www.test.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /usr/share/nginx/html/;</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>基于多IP的虚拟主机配置</strong></p>
<p> 基本步骤：增加网卡获得多ip或者增加辅助ip，修改nginx配置文件配置多ip，重启nginx服务，创建对应的不同站点目录并上传站点文件，也可都使用一个站点目录，通过多ip来访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">...</span><br><span class="line">server &#123;</span><br><span class="line">	listen 10.0.0.7:80;</span><br><span class="line">	server_name www.test.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /usr/share/nginx/html/;</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 10.0.0.8:80;</span><br><span class="line">	server_name www.test.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /usr/share/nginx/html/;</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 10.0.0.9:80;</span><br><span class="line">	server_name www.test.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /usr/share/nginx/html/;</span><br><span class="line">		index index.html index.htm;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>增加辅助ip的方法:</p>
<ol>
<li><p>临时性增加辅助ip：</p>
<p>方法一：<code>ifconfig eth0:1 10.0.0.8/24 up</code></p>
<p>方法二：ip addr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 10.0.0.9/24 dev eth0#（使用ip addr能查看）</span><br><span class="line"></span><br><span class="line">ip addr add 10.0.0.9/24 label eth0:2 dev eth0 #（使用ifconfig和ipaddr都能查看，推荐使用）</span><br></pre></td></tr></table></figure></li>
<li><p>永久增加辅助ip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/sysconfig/network-scripts/    <span class="comment">#进入到网卡配置文件的目录</span></span><br><span class="line"></span><br><span class="line">cp ifcfg-eth0 ifcfg-eth0:1                <span class="comment">#拷贝配置文件并重命名</span></span><br><span class="line"></span><br><span class="line">vim ifcfg-eth0:1                        <span class="comment">#编辑配置文件</span></span><br><span class="line"></span><br><span class="line">/etc/init.d/network restart            <span class="comment">#重启网络服务</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><p>Nginx日志主要分为两种：访问日志和错误日志。日志开关在Nginx配置文件（/etc/nginx/nginx.conf）中设置，两种日志都可以选择性关闭，默认都是打开的。</p>
<p><strong>访问日志</strong></p>
<p>访问日志主要记录客户端访问Nginx的每一个请求，格式可以自定义。通过访问日志，你可以得到用户地域来源、跳转来源、使用终端、某个URL访问量等相关信息。Nginx中访问日志相关指令主要有两条：</p>
<ol>
<li><p>log_format</p>
<p>log_format用来设置日志格式，也就是日志文件中每条日志的格式，具体如下：<br><code>log_format name(格式名称) type(格式样式)</code></p>
<p>举例说明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_format main &#x27;$server_name $remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">				&#x27;$status $uptream_status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">				&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#x27;</span><br><span class="line">				&#x27;$ssl_protocol $ssl_cipher $upstream_addr $request_time $upstream_response_time&#x27;;</span><br></pre></td></tr></table></figure>

<p>每个样式的含义如下：</p>
<ul>
<li>$server_name：虚拟主机名称。</li>
<li>$remote_addr：远程客户端的IP地址。</li>
<li>-：空白，用一个“-”占位符替代，历史原因导致还存在。</li>
<li>$remote_user：远程客户端用户名称，用于记录浏览者进行身份验证时提供的名字，如登录百度的用户名scq2099yt，如果没有登录就是空白。</li>
<li>[$time_local]：访问的时间与时区，比如18/Jul/2012:17:00:01 +0800，时间信息最后的”+0800”表示服务器所处时区位于UTC之后的8小时。</li>
<li>$request：请求的URI和HTTP协议，这是整个PV日志记录中最有用的信息，记录服务器收到一个什么样的请求</li>
<li>$status：记录请求返回的http状态码，比如成功是200。</li>
<li>$uptream_status：upstream状态，比如成功是200.</li>
<li>$upstream_addr:后端服务器的IP地址</li>
<li>$upstream_status：后端服务器返回的HTTP状态码<pre><code>在server&#123;&#125;中添加
  add_header backendIP $upstream_addr;
  add_header backendCode $upstream_status;
</code></pre>
</li>
<li>$body_bytes_sent：发送给客户端的文件主体内容的大小，比如899，可以将日志每条记录中的这个值累加起来以粗略估计服务器吞吐量。</li>
<li>$http_referer：记录从哪个页面链接访问过来的。 </li>
<li>$http_user_agent：客户端浏览器信息</li>
<li>$http_x_forwarded_for：客户端的真实ip，通常web服务器放在反向代理的后面，这样就不能获取到客户的IP地址了，通过$remote_add拿到的IP地址是反向代理服务器的iP地址。反向代理服务器在转发请求的http头信息中，可以增加x_forwarded_for信息，用以记录原有客户端的IP地址和原来客户端的请求的服务器地址。</li>
<li>$ssl_protocol：SSL协议版本，比如TLSv1。</li>
<li>$ssl_cipher：交换数据中的算法，比如RC4-SHA。 </li>
<li>$upstream_addr：upstream的地址，即真正提供服务的主机地址。 </li>
<li>$request_time：整个请求的总时间。 </li>
<li>$upstream_response_time：请求过程中，upstream的响应时间。</li>
</ul>
<p>访问日志中一个典型的记录如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.102 - scq2099yt [18/Mar/2013:23:30:42 +0800] &quot;GET /stats/awstats.pl?config=scq2099yt HTTP/1.1&quot; 200 899 &quot;http://192.168.1.1/pv/&quot; &quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows XXX; Maxthon)&quot;</span><br></pre></td></tr></table></figure>

<p>需要注意的是：log_format配置必须放在http内，否则会出现如下警告信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx: [warn] the &quot;log_format&quot; directive may be used only on &quot;http&quot; level in /etc/nginx/nginx.conf:97</span><br></pre></td></tr></table></figure></li>
<li><p>access_log</p>
<p>日志级别： <code>debug &gt; info &gt; notice &gt; warn &gt; error &gt; crit &gt; alert &gt; emerg</code></p>
<p>access_log指令用来指定日志文件的存放路径（包含日志文件名）、格式和缓存大小，具体如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">access_log path(存放路径) [format(自定义日志格式名称) [buffer=size | off]]</span><br><span class="line"></span><br><span class="line">语法格式:   access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];</span><br><span class="line">                     access_log off;</span><br><span class="line">默认值   : access_log logs/access.log combined;</span><br><span class="line">作用域   : http, server, location, if in location, limit_except</span><br></pre></td></tr></table></figure>

<p>举例说明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access_log logs/access.log main;</span><br><span class="line">access_log /spool/logs/nginx-access.log compression buffer=32k;</span><br></pre></td></tr></table></figure>

<p>如果想关闭日志，可以如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access_log off;</span><br></pre></td></tr></table></figure>

<p>能够使用access_log指令的字段包括：http、server、location。</p>
<p>需要注意的是：Nginx进程设置的用户和组必须对日志路径有创建文件的权限，否则，会报错。</p>
<p>Nginx支持为每个location指定强大的日志记录。同样的连接可以在同一时间输出到不止一个的日志中。</p>
</li>
<li><p>open_log_file_cache</p>
<p>使用open_log_file_cache来设置日志文件缓存(默认是off)。</p>
<ul>
<li>max:设置缓存中的最大文件描述符数量，如果缓存被占满，采用LRU算法将描述符关闭。</li>
<li>inactive:设置存活时间，默认是10s</li>
<li>min_uses:设置在inactive时间段内，日志文件最少使用多少次后，该日志文件描述符记入缓存中，默认是1次</li>
<li>valid:设置检查频率，默认60s</li>
<li>off：禁用缓存</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法格式:   open_log_file_cache max=N [inactive=time] [min_uses=N] [valid=time];</span><br><span class="line">                     open_log_file_cache off;</span><br><span class="line">默认值:     open_log_file_cache off;</span><br><span class="line">作用域:     http, server, location</span><br></pre></td></tr></table></figure>

<p>实例一</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_log_file_cache max=1000 inactive=20s valid=1m min_uses=2;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>错误日志</strong></p>
<p>错误日志主要记录客户端访问Nginx出错时的日志，格式不支持自定义。通过错误日志，你可以得到系统某个服务或server的性能瓶颈等。因此，将日志好好利用，你可以得到很多有价值的信息。错误日志由指令error_log来指定，具体格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_log path(存放路径) level(日志等级)</span><br></pre></td></tr></table></figure>

<p>path含义同access_log，level表示日志等级，具体如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ debug | info | notice | warn | error | crit ]</span><br></pre></td></tr></table></figure>

<p>从左至右，日志详细程度逐级递减，即debug最详细，crit最少。</p>
<p>举例说明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_log logs/error.log info;</span><br></pre></td></tr></table></figure>

<p>需要注意的是：error_log off并不能关闭错误日志，而是会将错误日志记录到一个文件名为off的文件中。<br>正确的关闭错误日志记录功能的方法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_log /dev/null;</span><br></pre></td></tr></table></figure>

<p>上面表示将存储日志的路径设置为“垃圾桶”。</p>
<p><strong>日志分割/备份</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#name:backup_nginx_log.sh</span></span><br><span class="line"><span class="comment">#desc:把当前日志按日期备份，重新生成第二天的日志文件</span></span><br><span class="line"><span class="comment">#date:2016-09-18</span></span><br><span class="line"> </span><br><span class="line">DATE=`date +%Y%m%d`</span><br><span class="line">NGINX_PID=`cat /var/run/nginx.pid`</span><br><span class="line"><span class="comment">#如果当前Nginx没有运行就退出</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;$?&quot;</span> != 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#nginx 日志所在的路径</span></span><br><span class="line">LOG_PATH=<span class="string">&#x27;/var/log/nginx/&#x27;</span></span><br><span class="line">LOG_NAME=<span class="string">&#x27;access.log&#x27;</span></span><br><span class="line"><span class="comment">#避免重复运行而造成覆盖</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$&#123;LOG_PATH&#125;</span><span class="variable">$&#123;LOG_NAME&#125;</span><span class="variable">$DATE</span> ];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;日志已存在&quot;</span></span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">mv <span class="variable">$&#123;LOG_PATH&#125;</span><span class="variable">$&#123;LOG_NAME&#125;</span> <span class="variable">$&#123;LOG_PATH&#125;</span><span class="variable">$&#123;LOG_NAME&#125;</span><span class="variable">$DATE</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#删除7天前旧的备份文件</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">deloldbak</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    olddate=`date +<span class="string">&quot;%Y%m%d&quot;</span> -d <span class="string">&quot;-<span class="variable">$1</span> day&quot;</span>`</span><br><span class="line">    <span class="keyword">if</span> [ -e <span class="string">&quot;<span class="variable">$&#123;LOG_PATH&#125;</span><span class="variable">$&#123;LOG_NAME&#125;</span><span class="variable">$olddate</span>&quot;</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        rm -f <span class="variable">$&#123;LOG_PATH&#125;</span><span class="variable">$&#123;LOG_NAME&#125;</span><span class="variable">$olddate</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;LOG_PATH&#125;</span><span class="variable">$&#123;LOG_NAME&#125;</span><span class="variable">$olddate</span> del OK&quot;</span> </span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#重载nginx配置，重新生成nginx日志文件</span></span><br><span class="line"><span class="built_in">kill</span> -USR1 <span class="variable">$NGINX_PID</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;$?&quot;</span> == 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    deloldbak 7</span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><strong>nginx日志调试技巧</strong></p>
<ol>
<li><p>设置 Nginx 仅记录来自于你的 IP 的错误</p>
<p>当你设置日志级别成 debug，如果你在调试一个在线的高流量网站的话，你的错误日志可能会记录每个请求的很多消息，这样会变得毫无意义。</p>
<p>在<code>events&#123;...&#125;</code>中配置如下内容，可以使 Nginx 记录仅仅来自于你的 IP 的错误日志。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">        debug_connection 1.2.3.4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>调试 nginx rewrite 规则</p>
<p>调试rewrite规则时，如果规则写错只会看见一个404页面，可以在配置文件中开启nginx rewrite日志，进行调试。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        error_log    /var/logs/nginx/example.com.error.log;</span><br><span class="line">        rewrite_log on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>rewrite_log on;</code> 开启后，它将发送所有的 rewrite 相关的日志信息到 error_log 文件中，使用 [notice] 级别。随后就可以在error_log 查看rewrite信息了。</p>
</li>
<li><p>使用location记录指定URL的日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        error_log    /var/logs/nginx/example.com.error.log;</span><br><span class="line">        location /static/ &#123; </span><br><span class="line">        error_log /var/logs/nginx/static-error.log debug; </span><br><span class="line">    &#125;         </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置以上配置后，/static/ 相关的日志会被单独记录在static-error.log文件中。</p>
<p>nginx日志共三个参数<br>access_log: 定义日志的路径及格式。<br>log_format: 定义日志的模板。<br>open_log_file_cache: 定义日志文件缓存。</p>
<p>proxy_set_header X-Forwarded-For ：如果后端Web服务器上的程序需要获取用户IP，从该Header头获取。<code>proxy_set_header X-Forwarded-For $remote_addr;</code></p>
</li>
</ol>
<p><strong>常用例子</strong></p>
<ol>
<li>main格式</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><br><span class="line">                       &#x27;$upstream_addr $upstream_response_time $request_time &#x27;;</span><br><span class="line">access_log  logs/access.log  main;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>json格式</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log_format logstash_json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class="line">       &#x27;&quot;host&quot;: &quot;$server_addr&quot;,&#x27;</span><br><span class="line">       &#x27;&quot;client&quot;: &quot;$remote_addr&quot;,&#x27;</span><br><span class="line">       &#x27;&quot;size&quot;: $body_bytes_sent,&#x27;</span><br><span class="line">       &#x27;&quot;responsetime&quot;: $request_time,&#x27;</span><br><span class="line">       &#x27;&quot;domain&quot;: &quot;$host&quot;,&#x27;</span><br><span class="line">       &#x27;&quot;url&quot;:&quot;$request_uri&quot;,&#x27;</span><br><span class="line">       &#x27;&quot;referer&quot;: &quot;$http_referer&quot;,&#x27;</span><br><span class="line">       &#x27;&quot;agent&quot;: &quot;$http_user_agent&quot;,&#x27;</span><br><span class="line">       &#x27;&quot;status&quot;:&quot;$status&quot;,&#x27;</span><br><span class="line">       &#x27;&quot;x_forwarded_for&quot;:&quot;$http_x_forwarded_for&quot;&#125;&#x27;;</span><br></pre></td></tr></table></figure>

<p>解释：<br><code>$uri</code>请求中的当前URI(不带请求参数，参数位于<code>$args</code>)，不同于浏览器传递的<code>$request_uri</code>的值，它可以通过内部重定向，或者使用index指令进行修改。不包括协议和主机名，例如/foo/bar.html。<br><code>$request_uri</code> 这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看<code>$uri</code>更改或重写URI。<br>也就是说：<code>$request_uri</code>是原始请求URL，<code>$uri</code>则是经过nginx处理请求后剔除参数的URL,所以会将汉字表现为union。<br>坑点：<br>使用<code>$uri</code> 可以在nginx对URL进行更改或重写，但是用于日志输出可以使用<code>$request_uri</code>代替，如无特殊业务需求，完全可以替换。</p>
<ol start="3">
<li>压缩格式</li>
</ol>
<p>日志中增加了压缩的信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    log_format compression &#x27;$remote_addr - $remote_user [$time_local] &#x27;</span><br><span class="line">                           &#x27;&quot;$request&quot; $status $body_bytes_sent &#x27;</span><br><span class="line">                           &#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$gzip_ratio&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        gzip on;</span><br><span class="line">        access_log /spool/logs/nginx-access.log compression;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>upstream格式</li>
</ol>
<p>增加upstream消耗的时间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    log_format upstream_time &#x27;$remote_addr - $remote_user [$time_local] &#x27;</span><br><span class="line">                             &#x27;&quot;$request&quot; $status $body_bytes_sent &#x27;</span><br><span class="line">                             &#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&#x27;</span><br><span class="line">                             &#x27;rt=$request_time uct=&quot;$upstream_connect_time&quot; uht=&quot;$upstream_header_time&quot; urt=&quot;$upstream_response_time&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        access_log /spool/logs/nginx-access.log upstream_time;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>统计status 出现的次数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;&#123;print $9&#125;&#x27; access.log | sort | uniq -c | sort -rn</span><br></pre></td></tr></table></figure></li>
<li><p>显示返回302状态码的URL。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;($9 ~ /302/)&#x27; access.log | awk &#x27;&#123;print $7&#125;&#x27; | sort | uniq -c | sort -rn</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="日志分析工具"><a href="#日志分析工具" class="headerlink" title="日志分析工具"></a>日志分析工具</h4><h5 id="ngxtop"><a href="#ngxtop" class="headerlink" title="ngxtop"></a><a target="_blank" rel="noopener" href="https://github.com/lebinh/ngxtop">ngxtop</a></h5><p>ngxtop 不仅可以对以前的日志进行排序、整理还可以实时监控 Nginx 日志。</p>
<p>ngxtop 是 Python 编写的，所以安装需要 Python2 或者 Python3 的环境，大家需要自行先配置好 Python 的环境。使用 pip 来安装 ngxtop ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum install python-pip -y</span><br><span class="line">#或</span><br><span class="line">apt-get install python-pip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pip install --upgrade pip</span><br><span class="line">#然后</span><br><span class="line">pip install ngxtop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">print|top|avg|sum</span><br><span class="line">ngxtop info 显示日志格式信息</span><br><span class="line">-l &lt;file&gt;或--access-log &lt;file&gt; 设置日志路径</span><br><span class="line">-f &lt;format&gt;或--log-format &lt;format&gt; 设置日志格式，默认格式combined，另外一种较常用格式为common</span><br><span class="line">--no-follow 处理以前的日志，实时日志不做处理</span><br><span class="line">-t &lt;seconds&gt; 或 --interval &lt;seconds&gt; 刷新频率，默认2秒</span><br><span class="line">-g &lt;var&gt;或 --group-by &lt;var&gt; 按变量分组，默认显示 request_path</span><br><span class="line">-w &lt;var&gt;或 --having &lt;expr&gt; 筛选 [default: 1]</span><br><span class="line">-o &lt;var&gt;或 --order-by &lt;var&gt; 输出的排序方式，默认: 访问数</span><br><span class="line">-n &lt;number&gt;或 --limit &lt;number&gt; 显示top多条，默认前top 10条</span><br><span class="line">-a &lt;exp&gt; ...或 --a &lt;exp&gt; ... 对输出字段做处理，可选 sum, avg, min, max</span><br><span class="line">-v或 --verbose 详细输出</span><br><span class="line">-d或 --debug debug模式，输出每行及记录</span><br><span class="line">-h或 --help 显示帮助详细</span><br><span class="line">--version 显示版本信息</span><br><span class="line">-c &lt;file&gt;或 --config &lt;file&gt; 指定nginx配置文件，自动分析日志格式</span><br><span class="line">-i &lt;filter-expression&gt;或 --filter &lt;filter-expression&gt; 满足表达式的过滤将被处理</span><br><span class="line">-p &lt;filter-expression&gt;或 --pre-filter &lt;filter-expression&gt; in-filter expression to check in pre-parsing phase.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>另外一些变量可以在分析时用到，名字含义同日志格式里的设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remote_addr、remote_user、time_local、request、request_path、status、body_bytes_sent、http_referer、http_user_agent</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2019/10/14/n3WOgUP8dwSC1Zp.png" alt="image.png"></p>
<p>使用实例：</p>
<ol>
<li><p>实时监控日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngxtop -l /home/wwwlogs/www.imydl.tech.log</span><br></pre></td></tr></table></figure>

<p>虽然直接执行 ngxtop 会自动搜索 nginx.conf ，但是直接解析里面默认虚拟主机的，建议直接指定日志文件。可以指定上 -n限定条数，也可以指定上 -g http_user_agent 按 useragent 查看。</p>
</li>
<li><p>日志分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngxtop -l /home/wwwlogs/www.imydl.tech.log --no-follow</span><br></pre></td></tr></table></figure>

<p>可以加一下参数进行详细分析，下面几个例子</p>
<p>按rquest_path且是404的前10请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngxtop -l /home/wwwlogs/www.imydl.tech.log --no-follow top request_path --filter &#x27;status == 404&#x27;</span><br></pre></td></tr></table></figure>

<p>按总bytes sent最高的前10：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngxtop -l /home/wwwlogs/www.imydl.tech.log --no-follow --order-by &#x27;avg(bytes_sent) * count&#x27;</span><br></pre></td></tr></table></figure>

<p>按remote address进行排序前10：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngxtop -l /home/wwwlogs/www.imydl.tech.log --no-follow --group-by remote_addr</span><br></pre></td></tr></table></figure>

<p>显示400或更高返回状态码的且只显示request、status、http_referer这三列信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngxtop -l /home/wwwlogs/www.imydl.tech --no-follow -i &#x27;status &gt;= 400&#x27; print request status http_referer</span><br></pre></td></tr></table></figure>

<p>显示bytes_sent平均值且状态码为200且request_path以vpser开始的前10：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngxtop -l /home/wwwlogs/www.imydl.tech.log --no-follow avg bytes_sent --filter &#x27;status == 200 and request_path.startswith(&quot;vpser&quot;)&#x27;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>大家可以组合前面的命令进行日志的实时监控和日志排查整理，相信ngxtop会给大家带来一些管理上的方便。</p>
<h5 id="GoAccess"><a href="#GoAccess" class="headerlink" title="GoAccess"></a><a target="_blank" rel="noopener" href="https://www.goaccess.cc/">GoAccess</a></h5><p>需求：及时得到线上用户nginx访问日志分析统计结果！</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2019/10/14/OMJwGRABdbnjNrz.png" alt="image.png"></p>
<p><strong>具体安装：</strong></p>
<ol>
<li>编译安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum install glib2 glib2-devel GeoIP-devel  ncurses-devel zlib zlib-devel -y</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget http://tar.goaccess.io/goaccess-1.2.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -xzvf goaccess-1.2.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> goaccess-1.2/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --prefix=/opt/goaccess --enable-utf8 --enable-geoip=legacy</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make &amp;&amp; make install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ln -s /opt/goaccess/bin/goaccess /usr/bin/goaccess</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>在各主流 Linux 发行版上安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">Debian/Ubuntu</span></span><br><span class="line"></span><br><span class="line">sudo apt-get install goaccess</span><br><span class="line"><span class="meta">#</span><span class="bash">或 官方 GoAccess Debian/Ubuntu 仓库</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;deb http://deb.goaccess.io/ <span class="subst">$(lsb_release -cs)</span> main&quot;</span> | sudo tee -a /etc/apt/sources.list.d/goaccess.list</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget -O - https://deb.goaccess.io/gnugpg.key | sudo apt-key add -</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install goaccess</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">如需支持 on-disk(Trusty+ or Wheezy+), 请运行：sudo apt-get install goaccess-tcb。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">官方库已经支持通过 https 获取 .deb 格式包文件，您可能需要安装 apt-transport-https。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">Fedora/CentOS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install goaccess</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>更多参考<a target="_blank" rel="noopener" href="https://www.goaccess.cc/?mod=download">官网</a></p>
</li>
<li><p>docker安装</p>
<p>在 Docker 容器中运行 GoAccess 之前，请先在 /srv/goaccess/data 目录下创建配置文件。 您可以自行从头开始或者使用 <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/allinurl/goaccess/master/config/goaccess.conf">config/goaccess.conf</a> 作为起点并根据需要进行修改。</p>
<p>一份最小化的支持实时 HTML 报告的适用于 Docker 容器的配置文件至少需要设置以下这些选项：<code>log-format</code>, <code>log-file</code>, <code>output</code>, <code>real-time-html</code> 以及 <code>ws-url</code>。</p>
<p>配置文件准备好以后，请从 Github 上克隆源码仓库到本地：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/allinurl/goaccess.git goaccess &amp;&amp; cd $_</span><br></pre></td></tr></table></figure>

<p>接着请按照如下步骤创建并运行镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker build . -t allinurl/goaccess</span><br><span class="line">docker run --restart=always -d -p 7890:7890 \</span><br><span class="line">  -v &quot;/srv/goaccess/data:/srv/data&quot;         \</span><br><span class="line">  -v &quot;/srv/goaccess/html:/srv/report&quot;       \</span><br><span class="line">  -v &quot;/var/log/apache2:/srv/logs&quot;           \</span><br><span class="line">  --name=goaccess allinurl/goaccess</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong> 可能您需要替换 <code>/var/log/apache2</code> 为您自己的 Web 服务器的访问日志。</p>
<p>如果一切顺利，一份安装报告将会出现在 <code>/srv/goaccess/html/</code> 目录下。</p>
<p>如果在构建镜像之后修改了配置文件，是不需要重新构建的。简单的重启容器即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart goaccess</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>用法：</strong></p>
<p>参考<a target="_blank" rel="noopener" href="https://www.goaccess.cc/?mod=man">官方文档</a></p>
<p>使用nginx2goaccess.sh脚本将nginx日志格式格式化为goaccess能识别的日志格式，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Convert from this:</span></span><br><span class="line"><span class="comment">#   http://nginx.org/en/docs/http/ngx_http_log_module.html</span></span><br><span class="line"><span class="comment"># To this:</span></span><br><span class="line"><span class="comment">#   https://goaccess.io/man</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Conversion table:</span></span><br><span class="line"><span class="comment">#   $time_local         %d:%t %^</span></span><br><span class="line"><span class="comment">#   $host               %v</span></span><br><span class="line"><span class="comment">#   $http_host          %v</span></span><br><span class="line"><span class="comment">#   $remote_addr        %h</span></span><br><span class="line"><span class="comment">#   $request_time       %T</span></span><br><span class="line"><span class="comment">#   $request_method     %m</span></span><br><span class="line"><span class="comment">#   $request_uri        %U</span></span><br><span class="line"><span class="comment">#   $server_protocol    %H</span></span><br><span class="line"><span class="comment">#   $request            %r</span></span><br><span class="line"><span class="comment">#   $status             %s</span></span><br><span class="line"><span class="comment">#   $body_bytes_sent    %b</span></span><br><span class="line"><span class="comment">#   $bytes_sent         %b</span></span><br><span class="line"><span class="comment">#   $http_referer       %R</span></span><br><span class="line"><span class="comment">#   $http_user_agent    %u</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Samples:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># log_format combined &#x27;$remote_addr - $remote_user [$time_local] &#x27;</span></span><br><span class="line"><span class="comment"># &#x27;&quot;$request&quot; $status $body_bytes_sent &#x27;</span></span><br><span class="line"><span class="comment"># &#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot;&#x27;;</span></span><br><span class="line"><span class="comment">#   ./nginx2goaccess.sh &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot;&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># log_format compression &#x27;$remote_addr - $remote_user [$time_local] &#x27;</span></span><br><span class="line"><span class="comment"># &#x27;&quot;$request&quot; $status $bytes_sent &#x27;</span></span><br><span class="line"><span class="comment"># &#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$gzip_ratio&quot;&#x27;;</span></span><br><span class="line"><span class="comment">#   ./nginx2goaccess.sh &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$gzip_ratio&quot;&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># log_format main</span></span><br><span class="line"><span class="comment"># &#x27;$remote_addr\t$time_local\t$host\t$request\t$http_referer\t$http_x_mobile_group\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;Local:\t$status\t$body_bytes_sent\t$request_time\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;Proxy:\t$upstream_cache_status\t$upstream_status\t$upstream_response_length\t$upstream_response_time\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;Agent:\t$http_user_agent\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;Fwd:\t$http_x_forwarded_for&#x27;;</span></span><br><span class="line"><span class="comment">#   ./nginx2goaccess.sh &#x27;$remote_addr\t$time_local\t$host\t$request\t$http_referer\t$http_x_mobile_group\tLocal:\t$status\t$body_bytes_sent\t$request_time\tProxy:\t$upstream_cache_status\t$upstream_status\t$upstream_response_length\t$upstream_response_time\tAgent:\t$http_user_agent\tFwd:\t$http_x_forwarded_for&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># log_format main</span></span><br><span class="line"><span class="comment"># &#x27;$&#123;time_local&#125;\t$&#123;remote_addr&#125;\t$&#123;host&#125;\t$&#123;request_method&#125;\t$&#123;request_uri&#125;\t$&#123;server_protocol&#125;\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;$&#123;http_referer&#125;\t$&#123;http_x_mobile_group&#125;\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;Local:\t$&#123;status&#125;\t*$&#123;connection&#125;\t$&#123;body_bytes_sent&#125;\t$&#123;request_time&#125;\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;Proxy:\t$&#123;upstream_status&#125;\t$&#123;upstream_cache_status&#125;\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;$&#123;upstream_response_length&#125;\t$&#123;upstream_response_time&#125;\t$&#123;uri&#125;$&#123;log_args&#125;\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;Agent:\t$&#123;http_user_agent&#125;\t&#x27;</span></span><br><span class="line"><span class="comment"># &#x27;Fwd:\t$&#123;http_x_forwarded_for&#125;&#x27;;</span></span><br><span class="line"><span class="comment">#   ./nginx2goaccess.sh &#x27;$&#123;time_local&#125;\t$&#123;remote_addr&#125;\t$&#123;host&#125;\t$&#123;request_method&#125;\t$&#123;request_uri&#125;\t$&#123;server_protocol&#125;\t$&#123;http_referer&#125;\t$&#123;http_x_mobile_group&#125;\tLocal:\t$&#123;status&#125;\t*$&#123;connection&#125;\t$&#123;body_bytes_sent&#125;\t$&#123;request_time&#125;\tProxy:\t$&#123;upstream_status&#125;\t$&#123;upstream_cache_status&#125;\t$&#123;upstream_response_length&#125;\t$&#123;upstream_response_time&#125;\t$&#123;uri&#125;$&#123;log_args&#125;\tAgent:\t$&#123;http_user_agent&#125;\tFwd:\t$&#123;http_x_forwarded_for&#125;&#x27;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: Rogério Carvalho Schneider &lt;stockrt@gmail.com&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Params</span></span><br><span class="line">log_format=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Usage</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$log_format</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> &#x27;&lt;log_format&gt;&#x27;&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Variables map</span></span><br><span class="line">conversion_table=<span class="string">&quot;time_local,%d:%t_%^</span></span><br><span class="line"><span class="string">host,%v</span></span><br><span class="line"><span class="string">http_host,%v</span></span><br><span class="line"><span class="string">remote_addr,%h</span></span><br><span class="line"><span class="string">request_time,%T</span></span><br><span class="line"><span class="string">request_method,%m</span></span><br><span class="line"><span class="string">request_uri,%U</span></span><br><span class="line"><span class="string">server_protocol,%H</span></span><br><span class="line"><span class="string">request,%r</span></span><br><span class="line"><span class="string">status,%s</span></span><br><span class="line"><span class="string">body_bytes_sent,%b</span></span><br><span class="line"><span class="string">bytes_sent,%b</span></span><br><span class="line"><span class="string">http_referer,%R</span></span><br><span class="line"><span class="string">http_user_agent,%u&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Conversion</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> <span class="variable">$conversion_table</span>; <span class="keyword">do</span></span><br><span class="line">    nginx_var=<span class="variable">$&#123;item%%,*&#125;</span></span><br><span class="line">    goaccess_var=<span class="variable">$&#123;item##*,&#125;</span></span><br><span class="line">    goaccess_var=<span class="variable">$&#123;goaccess_var//_/ &#125;</span></span><br><span class="line">    log_format=<span class="variable">$&#123;log_format//\$\&#123;$nginx_var\&#125;</span>/<span class="variable">$goaccess_var</span>&#125;</span><br><span class="line">    log_format=<span class="variable">$&#123;log_format//\$$nginx_var/$goaccess_var&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">log_format=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$log_format</span>&quot;</span> | sed <span class="string">&#x27;s/$&#123;[a-z_]*&#125;/%^/g&#x27;</span>)</span><br><span class="line">log_format=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$log_format</span>&quot;</span> | sed <span class="string">&#x27;s/$[a-z_]*/%^/g&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Config output</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">- Generated goaccess config:</span></span><br><span class="line"><span class="string">time-format %T</span></span><br><span class="line"><span class="string">date-format %d/%b/%Y</span></span><br><span class="line"><span class="string">log_format <span class="variable">$log_format</span></span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EOF</span></span><br></pre></td></tr></table></figure>

<p>使用如下方式获取日志格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sh nginx2goaccess.sh &#x27;&lt;log_format&gt;&#x27;　　　　　　　　　#log_format为你nginx.conf中配置的日志格式</span><br><span class="line">　　　</span><br><span class="line">　#如：</span><br><span class="line">sh nginx2goaccess.sh &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p>会得到的结果，在goaccess-1.3/config下面创建一个nginxlog.conf：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#- Generated goaccess config:</span><br><span class="line">time-format %T</span><br><span class="line">date-format %d/%b/%Y</span><br><span class="line">log_format %h - %^ [%d:%t %^] &quot;%r&quot; %s %b &quot;%R&quot; &quot;%u&quot; &quot;%^&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置见证奇迹的时刻，生成统计页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">goaccess -f /var/log/nginx/access.log -p /opt/goaccess/etc/nginxlog.conf -o /usr/share/nginx/html/report.html</span><br><span class="line">#或生成中文的方法</span><br><span class="line">LANG=&quot;zh_CN.UTF-8&quot; bash -c &quot;goaccess -f /var/log/nginx/access.log -p /opt/goaccess/etc/nginxlog.conf -o /usr/share/nginx/html/report.html&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#html可视化文件的实时更新方法</span><br><span class="line">nohup goaccess -f /var/log/nginx/access.log -p /opt/goaccess/etc/nginxlog.conf -o /usr/share/nginx/html/report.html --real-time-html --ws-url=report.xxx.com &amp;</span><br></pre></td></tr></table></figure>

<p>GoAccess还为实时过滤和解析提供了极大的灵活性。例如，自goaccess启动以来通过监视日志来快速诊断问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f access.log | goaccess - </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">日志格式符号解释</span><br><span class="line">%x 与时间格式和日期格式变量匹配的日期和时间字段。当给出时间戳而不是日期和时间在两个单独的变量中时使用。</span><br><span class="line">%t 时间字段匹配时间格式变量。</span><br><span class="line">%d 与日期格式变量匹配的日期字段。</span><br><span class="line">%v 服务器名称根据规范名称设置（服务器块或虚拟主机）。</span><br><span class="line">%e 这是HTTP身份验证确定的请求文档的人的用户标识。</span><br><span class="line">%h host（客户端IP地址，IPv4或IPv6）</span><br><span class="line">%r 来自客户端的请求行。这需要围绕请求的特定分隔符（单引号，双引号等）可解析。否则，使用特殊的格式说明符，如组合%m，%U，%q和%H解析各个字段。</span><br><span class="line">注意：使用或者%r获得完整的请求OR %m，%U，%q并%H形成你的要求，不要同时使用。</span><br><span class="line">%m 请求方法。</span><br><span class="line">%U 请求的URL路径。</span><br><span class="line">注意：如果查询字符串在%U，则无需使用%q。但是，如果URL路径不包含任何查询字符串，则可以使用%q并将查询字符串附加到请求中。</span><br><span class="line">%q 查询字符串。</span><br><span class="line">%H 请求协议。</span><br><span class="line">%s 服务器发送回客户端的状态代码。</span><br><span class="line">%b 返回给客户端的对象大小。</span><br><span class="line">%R “Referer”HTTP请求标头。</span><br><span class="line">%u 用户代理HTTP请求标头。</span><br><span class="line">%D 服务请求所需的时间，以微秒为单位。</span><br><span class="line">%T 服务请求所需的时间，以毫秒为单位，分辨率为毫秒。</span><br><span class="line">%L 服务请求所用的时间，以毫秒为单位的十进制数。</span><br><span class="line">%^ 忽略此字段。</span><br><span class="line">%~向前移动日志字符串，直到找到非空格（！isspace）char。</span><br><span class="line">~h X-Forwarded-For（XFF）字段中的主机（客户端IP地址，IPv4或IPv6）。</span><br><span class="line"></span><br><span class="line">选项解释</span><br><span class="line">　　　-f 指定nginx日志文件</span><br><span class="line">　　　-p 指定日志格式文件</span><br><span class="line">　　　-o 输出到指定html文件</span><br><span class="line">　　　--real-time-html 实时刷新</span><br><span class="line">　　　--ws-url 绑定一个域名</span><br></pre></td></tr></table></figure>

<p>配置nginx访问刚刚生成的report.html页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/nginx/conf.d/goaccess.conf</span><br><span class="line">server&#123;</span><br><span class="line">	listen 8080;</span><br><span class="line">	server_name localhost;</span><br><span class="line"></span><br><span class="line">	location /report.html &#123;</span><br><span class="line">            alias /usr/share/nginx/html/report.html</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重启nginx</p>
<p>在浏览器就可以访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8080/report.html">http://127.0.0.1:8080/report.html</a></p>
<h4 id="Nginx解决跨域"><a href="#Nginx解决跨域" class="headerlink" title="Nginx解决跨域"></a>Nginx解决跨域</h4><p>很多人都会遇到 Nginx 跨域的问题, 而我遇到的问题是：</p>
<ul>
<li>客户端在 <a target="_blank" rel="noopener" href="http://www.a.com/">www.a.com</a></li>
<li>服务端在 <a target="_blank" rel="noopener" href="http://www.b.com/">www.b.com</a></li>
<li>Nginx 在 <a target="_blank" rel="noopener" href="http://www.c.com/">www.c.com</a></li>
</ul>
<p>此时需要对 Nginx 进行跨域配置才可以访问 <code>www.c.com</code> 的获取客户端 <code>www.a.com</code> 来请求 <code>www.b.com</code> 的数据, Nginx 配置如下(重要部分)：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span> $http_origin;</span><br><span class="line">    <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class="string">&#x27;GET, POST, OPTIONS&#x27;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class="string">&#x27;DNT,web-token,app-token,Authorization,Accept,Origin,Keep-Alive,User-Agent,X-Mx-ReqToken,X-Data-Type,X-Auth-Token,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range&#x27;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Expose-Headers&#x27;</span> <span class="string">&#x27;Content-Length,Content-Range&#x27;</span>;</span><br><span class="line">    <span class="attribute">if</span> ($request_method = <span class="string">&#x27;OPTIONS&#x27;</span>) &#123;</span><br><span class="line">            <span class="attribute">add_header</span> <span class="string">&#x27;Access-Control-Max-Age&#x27;</span> <span class="number">1728000</span>;</span><br><span class="line">            <span class="attribute">add_header</span> <span class="string">&#x27;Content-Type&#x27;</span> <span class="string">&#x27;text/plain; charset=utf-8&#x27;</span>;</span><br><span class="line">            <span class="attribute">add_header</span> <span class="string">&#x27;Content-Length&#x27;</span> <span class="number">0</span>;</span><br><span class="line">            <span class="attribute">return</span> <span class="number">204</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://xxx:8000/;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host $host;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP $remote_addr;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Forwarded-Proto $scheme;</span><br><span class="line">    <span class="attribute">proxy_connect_timeout</span> <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>别忘了把配置中 <code>proxy_pass</code> 对应的 <code>http://xxx:8000/</code> 地址换成你的服务地址, 当然了, 你的客户端请求的地址不可以是你的服务地址, 而是 Nginx 的地址, 这样就可以达到解决跨域的问题。</p>
<h4 id="nginx不转发http-header问题解决"><a href="#nginx不转发http-header问题解决" class="headerlink" title="nginx不转发http header问题解决"></a>nginx不转发http header问题解决</h4><ol>
<li>默认的情况下nginx引用header变量时不能使用带下划线的变量。要解决这样的问题只能单独配置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#underscores_in_headers">underscores_in_headers</a> on；</li>
<li>默认的情况下会忽略掉带下划线的变量。要解决这个需要配置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#ignore_invalid_headers">ignore_invalid_headers</a> off。</li>
<li>当然最好的方法就是不使用带下划线的header变量</li>
</ol>
<h4 id="Https配置"><a href="#Https配置" class="headerlink" title="Https配置"></a>Https配置</h4><p>有关 SSL 的介绍可以参阅维基百科的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%82%B3%E8%BC%B8%E5%B1%A4%E5%AE%89%E5%85%A8%E5%8D%94%E8%AD%B0">传输层安全协议</a>和阮一峰先生的 <a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">《SSL/TLS协议运行机制的概述》</a>。</p>
<p>SSL 证书主要有两个功能：<strong>加密</strong>和<strong>身份证明</strong>，通常需要购买，也有免费的，通过第三方 SSL 证书机构颁发，常见可靠的第三方 SSL 证书颁发机构有下面几个：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2019/10/15/oZiVID2xc13az9s.png" alt="image.png"></p>
<p><a target="_blank" rel="noopener" href="https://www.startssl.com/">StartCom</a> 机构上的 SSL 证书有以下几种：</p>
<ul>
<li>企业级别：EV(Extended Validation)、OV(Organization Validation)</li>
<li>个人级别：IV(Identity Validation)、DV（Domain Validation）</li>
</ul>
<p>其中 EV、OV、IV 需要付费</p>
<p>免费的证书安全认证级别一般比较低，不显示单位名称，不能证明网站的真实身份，仅起到加密传输信息的作用，适合个人网站或非电商网站。由于此类只验证域名所有权的低端 SSL 证书已经被国外各种欺诈网站滥用，因此强烈推荐部署验证单位信息并显示单位名称的 OV SSL 证书或申请最高信任级别的、显示绿色地址栏、直接在地址栏显示单位名称的 EV SSL 证书，就好像 <a target="_blank" rel="noopener" href="https://www.startssl.com/">StarCom</a> 的地址栏一样</p>
<p>更多关于购买 SSL 证书的介绍：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/19578422">SSL 证书服务，大家用哪家的？</a>、<a target="_blank" rel="noopener" href="http://freessl.wosign.com/freessl">DV免费SSL证书</a></p>
<p><strong>使用 OpenSSL 生成 SSL Key 和 CSR 文件</strong></p>
<p>配置 HTTPS 要用到私钥 example.key 文件和 example.crt 证书文件，申请证书文件的时候要用到 example.csr 文件，<code>OpenSSL</code> 命令可以生成 example.key 文件和 example.csr 证书文件。</p>
<ul>
<li>CSR：Cerificate Signing Request，证书签署请求文件，里面包含申请者的 DN（Distinguished Name，标识名）和公钥信息，<strong>在第三方证书颁发机构签署证书的时候需要提供</strong>。证书颁发机构拿到 CSR 后使用其根证书私钥对证书进行加密并生成 CRT 证书文件，里面包含证书加密信息以及申请者的 DN 及公钥信息</li>
<li>Key：证书申请者私钥文件，和证书里面的公钥配对使用，在 HTTPS 『握手』通讯过程需要使用私钥去解密客戶端发來的经过证书公钥加密的随机数信息，是 HTTPS 加密通讯过程非常重要的文件，<strong>在配置 HTTPS 的時候要用到</strong></li>
</ul>
<p>使用 <code>OpenSSl</code>命令可以在系统当前目录生成 <strong>example.key</strong> 和 <strong>example.csr</strong> 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -newkey rsa:2048 -sha256 -nodes -out example_com.csr -keyout example_com.key -subj <span class="string">&quot;/C=CN/ST=ShenZhen/L=ShenZhen/O=Example Inc./OU=Web Security/CN=example.com&quot;</span></span><br><span class="line"><span class="comment">#创建CA证书</span></span><br><span class="line">openssl req -new -x509 -key example_com.key -out ca.crt -days 3650  -subj <span class="string">&quot;/C=CN/ST=ShenZhen/L=ShenZhen/O=Example Inc./OU=Web Security/CN=example.com&quot;</span></span><br><span class="line"><span class="comment">#创建自当前日期起有效期为期十年的服务器证书server.crt</span></span><br><span class="line">openssl x509 -req -days 3650 -<span class="keyword">in</span> example_com.csr -CA ca.crt -CAkey example_com.key -CAcreateserial -out example_com.crt</span><br></pre></td></tr></table></figure>

<p>下面是上述第一条命令相关字段含义：</p>
<ul>
<li>C：Country ，单位所在国家，为两位数的国家缩写，如： CN 就是中国</li>
<li>ST 字段： State/Province ，单位所在州或省</li>
<li>L 字段： Locality ，单位所在城市 / 或县区</li>
<li>O 字段： Organization ，此网站的单位名称;</li>
<li>OU 字段： Organization Unit，下属部门名称;也常常用于显示其他证书相关信息，如证书类型，证书产品名称或身份验证类型或验证内容等;</li>
<li>CN 字段： Common Name ，网站的域名;</li>
</ul>
<p>生成 csr 文件后，提供给 CA 机构，签署成功后，就会得到一個 <strong>example.crt</strong> 证书文件，SSL 证书文件获得后，就可以在 Nginx 配置文件里配置 HTTPS 了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line">ca.crt ca.srl example_com.crt example_com.csr example_com.key</span><br></pre></td></tr></table></figure>

<p>其中,<code>example_com.crt</code>和<code>example_com.key</code>就是你的nginx需要的证书文件.</p>
<p><strong>配置 HTTPS</strong></p>
<p>要开启 HTTPS 服务，在配置文件信息块(server block)，必须使用监听命令 <code>listen</code> 的 ssl 参数和定义服务器证书文件和私钥文件，如下所示：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment">#ssl参数</span></span><br><span class="line">    <span class="attribute">listen</span>              <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span>         example.com;</span><br><span class="line">    <span class="comment">#证书文件</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span>     /opt/server/nginx/conf/example_com.crt;<span class="comment">#配置证书位置</span></span><br><span class="line">    <span class="comment">#私钥文件</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /opt/server/nginx/conf/example_com.key;<span class="comment">#配置秘钥位置</span></span><br><span class="line">    <span class="comment">#ssl_client_certificate ca.crt;#双向认证</span></span><br><span class="line">    <span class="comment">#ssl_verify_client on; #双向认证</span></span><br><span class="line">    </span><br><span class="line">    <span class="attribute">ssl_protocols</span>       TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span>         HIGH:!aNULL:!MD5;</span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span>  <span class="number">5m</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span>   <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>证书文件会作为公用实体發送到每台连接到服务器的客戶端，私钥文件作为安全实体，<strong>应该被存放在具有一定权限限制的目录文件，并保证 Nginx 主进程有存取权限</strong>。</p>
<p>私钥文件也有可能会和证书文件同放在一個文件中，如下面情況：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_certificate</span>     /opt/server/nginx/conf/example_com.cert;</span><br><span class="line"><span class="attribute">ssl_certificate_key</span> /opt/server/nginx/conf/example_com.cert;</span><br></pre></td></tr></table></figure>

<p>这种情況下，证书文件的的读取权限也应该加以限制，仅管证书和私钥存放在同一个文件里，但是只有证书会被发送到客戶端</p>
<p>命令 <code>ssl_protocols</code> 和 <code>ssl_ciphers</code> 可以用来限制连接只包含 SSL/TLS 的加強版本和算法，默认值如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line"><span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br></pre></td></tr></table></figure>

<p>由于这两个命令的默认值已经好几次发生了改变，因此不建议显性定义，除非有需要额外定义的值，如定义 D-H 算法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用DH文件</span></span><br><span class="line"><span class="attribute">ssl_dhparam</span> /etc/ssl/certs/dhparam.pem;</span><br><span class="line"><span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line"><span class="comment">#定义算法</span></span><br><span class="line"><span class="attribute">ssl_ciphers</span> <span class="string">&quot;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4&quot;</span>;</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure>

<p><strong>优化</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#配置共享会话缓存大小，视站点访问情况设定</span></span><br><span class="line">    <span class="attribute">ssl_session_cache</span>   shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="comment">#配置会话超时时间</span></span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>              <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span>         example.com;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#设置长连接</span></span><br><span class="line">        <span class="attribute">keepalive_timeout</span>   <span class="number">70</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#HSTS策略</span></span><br><span class="line">        <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains; preload&quot;</span> always;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">#证书文件</span></span><br><span class="line">        <span class="attribute">ssl_certificate</span>     /opt/server/nginx/conf/example_com.crt;</span><br><span class="line">        <span class="comment">#私钥文件</span></span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /opt/server/nginx/conf/example_com.key; </span><br><span class="line">        </span><br><span class="line">        <span class="comment">#优先采取服务器算法</span></span><br><span class="line">        <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="comment">#使用DH文件</span></span><br><span class="line">        <span class="attribute">ssl_dhparam</span> /etc/ssl/certs/dhparam.pem;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">        <span class="comment">#定义算法</span></span><br><span class="line">        <span class="attribute">ssl_ciphers</span> <span class="string">&quot;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4&quot;</span>;</span><br><span class="line">        <span class="comment">#减少点击劫持</span></span><br><span class="line">        <span class="attribute">add_header</span> X-Frame-Options DENY;</span><br><span class="line">        <span class="comment">#禁止服务器自动解析资源类型</span></span><br><span class="line">        <span class="attribute">add_header</span> X-Content-Type-Options nosniff;</span><br><span class="line">        <span class="comment">#防XSS攻擊</span></span><br><span class="line">        <span class="attribute">add_header</span> X-Xss-Protection <span class="number">1</span>;</span><br><span class="line">        <span class="comment">#...</span></span><br></pre></td></tr></table></figure>

<p><strong>HTTP/HTTPS混合服务器配置</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>              <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span>              <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span>         example.com;</span><br><span class="line">    <span class="attribute">ssl_certificate</span>     /opt/server/nginx/conf/example_com.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /opt/server/nginx/conf/example_com.key;</span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">平心</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://pingxin0521.gitee.io/2019/08/21/%E6%9C%8D%E5%8A%A1%E5%99%A8-Nginx-2-1/">https://pingxin0521.gitee.io/2019/08/21/%E6%9C%8D%E5%8A%A1%E5%99%A8-Nginx-2-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://pingxin0521.gitee.io" target="_blank">平心de小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/08/22/%E6%9C%8D%E5%8A%A1%E5%99%A8-Nginx-2-2/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">nginx 正向代理、反向代理、负载均衡和web缓存</div></div></a></div><div class="next-post pull-right"><a href="/2019/08/20/%E6%9C%8D%E5%8A%A1%E5%99%A8-Nginx-1-2/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">nginx 配置详解</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/11/16/服务器-Nginx-2-3/" title="nginx 常用屏蔽规则"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/PFDRNxj93taz6pw.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2021-01-09</div><div class="title">nginx 常用屏蔽规则</div></div></a></div><div><a href="/2019/08/20/服务器-Nginx-1-1/" title="nginx 安装"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/okfOw28KlZFbE7z.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-06-02</div><div class="title">nginx 安装</div></div></a></div><div><a href="/2019/08/29/服务器-Nginx-1-4/" title="nginx 常用http模块"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-12-28</div><div class="title">nginx 常用http模块</div></div></a></div><div><a href="/2019/08/20/服务器-Nginx-1-2/" title="nginx 配置详解"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-06-10</div><div class="title">nginx 配置详解</div></div></a></div><div><a href="/2019/08/28/服务器-Nginx-1-3/" title="nginx 架构"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-12-27</div><div class="title">nginx 架构</div></div></a></div><div><a href="/2019/08/22/服务器-Nginx-2-2/" title="nginx 正向代理、反向代理、负载均衡和web缓存"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2019-12-26</div><div class="title">nginx 正向代理、反向代理、负载均衡和web缓存</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/02/11/1ovw6J.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">平心</div><div class="author-info__description">年轻人的life、learn and think</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">449</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">77</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">68</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hanyunpeng0521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hanyunpeng0521" target="_blank" title="Github"><i class="fa fa-github"></i></a><a class="social-icon" href="mailto:m13839441583@163.com" target="_blank" title="Email"><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">为什么呢？开始提问吧</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD%E9%83%A8%E7%BD%B2"><span class="toc-number">1.</span> <span class="toc-text">热部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90Web%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">静态资源Web服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">3.</span> <span class="toc-text">日志</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-number">4.</span> <span class="toc-text">日志分析工具</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ngxtop"><span class="toc-number">4.1.</span> <span class="toc-text">ngxtop</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GoAccess"><span class="toc-number">4.2.</span> <span class="toc-text">GoAccess</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F"><span class="toc-number">5.</span> <span class="toc-text">Nginx解决跨域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E4%B8%8D%E8%BD%AC%E5%8F%91http-header%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-number">6.</span> <span class="toc-text">nginx不转发http header问题解决</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Https%E9%85%8D%E7%BD%AE"><span class="toc-number">7.</span> <span class="toc-text">Https配置</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/05/15/node-2-4/" title="Egg.js -- 为企业级框架和应用而生"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/okfOw28KlZFbE7z.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Egg.js -- 为企业级框架和应用而生"/></a><div class="content"><a class="title" href="/2021/05/15/node-2-4/" title="Egg.js -- 为企业级框架和应用而生">Egg.js -- 为企业级框架和应用而生</a><time datetime="2021-05-15T10:18:59.000Z" title="发表于 2021-05-15 18:18:59">2021-05-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/30/node-2-3/" title="Koa -- 基于Node.js平台的下一代Web开发框架"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koa -- 基于Node.js平台的下一代Web开发框架"/></a><div class="content"><a class="title" href="/2021/04/30/node-2-3/" title="Koa -- 基于Node.js平台的下一代Web开发框架">Koa -- 基于Node.js平台的下一代Web开发框架</a><time datetime="2021-04-30T10:18:59.000Z" title="发表于 2021-04-30 18:18:59">2021-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/01/node-2-1/" title="Node.JS web开发前置知识"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Node.JS web开发前置知识"/></a><div class="content"><a class="title" href="/2021/04/01/node-2-1/" title="Node.JS web开发前置知识">Node.JS web开发前置知识</a><time datetime="2021-04-01T03:18:59.000Z" title="发表于 2021-04-01 11:18:59">2021-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-1/" title="第十一周--谷歌浏览器插件"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第十一周--谷歌浏览器插件"/></a><div class="content"><a class="title" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-1/" title="第十一周--谷歌浏览器插件">第十一周--谷歌浏览器插件</a><time datetime="2020-12-26T10:18:59.000Z" title="发表于 2020-12-26 18:18:59">2020-12-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-0/" title="第十一周--浏览器技术"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第十一周--浏览器技术"/></a><div class="content"><a class="title" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-0/" title="第十一周--浏览器技术">第十一周--浏览器技术</a><time datetime="2020-12-26T06:18:59.000Z" title="发表于 2020-12-26 14:18:59">2020-12-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By 平心</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '4lfIXzqxaC1ONs0MJO4oHu07-gzGzoHsz',
      appKey: 'qw99Bw8FD0KVKU9m457CwWsr',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>