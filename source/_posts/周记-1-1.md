---
title: 第二周--BT和BT种子
date: 2019-11-18 18:18:59
tags:
 - 周记
categories:
 - 周记
---

### 本周速记

**方法论**

1. 区块链
2. BT

<!--more-->

### BT

我们前面谈论了区块链，里面讲到了去中心化，包括去中心化的网络，可以广义上认为是P2P网络的应用。

P2P在思想上可以说是internet思想/精神/哲学非常集中的体现，共同的参与，透明的开放，平等的分享（让我想起之前学习过的，现在正在疯狂热炒的云计算的“中央集权”制度）。基于P2P技术的应用有很多，包括文件分享，即时通信，协同处理，流媒体通信等等。通过这些应用的接触，分析和理解，P2P其本质是一种新的网络传播技术，这种新的传播技术打破了传统的C/S架构，逐步地去中心化，扁平化，这或许在一定程度上应证了”世界是平的”趋势，呵呵。P2P文件分享的应用(BTs/eMules等)是P2P技术最集中的体现，我们这里的研究也是以P2P文件分享网络作为入口，P2P文件分享网络的发展大致有以下几个阶段，包含tracker服务器的网络，无任何服务器的纯DHT网络， 混合型P2P网络。DHT网络发展即有“思想/文化”上的“发展”，也有一定的商业上的需求（版权管理）。

#### P2P（Peer to Peer）网络的原理

这里指的P2P是指**peer to peer**， 点对点的技术， 每个客户端都是服务端，没有中心服务器，不是websocket针对某个connection推送消息。

技术要点

- udp协议
- 节点之间的建立，连接和广播
- 内网穿透，如何能让两个处在内网的节点，相互发现自己的存在，并且建立通信

##### 原理

首先解决的是内网穿透的问题，常见的底层协议tcp，udp，他们各自有优缺点，简单说明一下。 tcp：需要处理粘包问题，双工流通道，是可靠的链接。 udp： 每次发送的都是数据包，没有粘包问题，但是连接不可靠，只能传输少量数据

这里选择udp协议，简单一些。

再下来是内网穿透，先说结论： **两个处于不同内部网络的节点，永远无法发现他们之间的相互存在**，你就算是想顺着网线过去打他都不行。

所有的内网穿透原理无外乎需要一个有公网ip的中介服务器，包括虚拟货币像比特币之类的，所以首先要有一个**创世节点**

在NodeJS中，创建udp服务也很简单

```js
const dgram = require("dgram");
const udp = dgram.createSocket("udp4");
udp.bind(1090, callback)
```

把服务部署要公网，那么其他所有的节点都能访问，通过中转服务器，能够使得两个节点可以建立连接

![Q9Fn2t.png](https://s2.ax1x.com/2019/11/27/Q9Fn2t.png)

我们是要建立这样的P2P网络

![Q9FMKf.png](https://s2.ax1x.com/2019/11/27/Q9FMKf.png)

假如现在只有3个节点： **创世节点**, **B节点**, **C节点**， 创世节点有公网IP

我用对话的形式，阐述他们建立链接的过程:

> B节点: hey，创世节点，我要加入到P2P网络里面，告诉其他兄弟，我来了 创世节点: 兄弟们，刚刚有个叫做B的节点加入网络了，你们也去告诉其他节点 其他节点: 刚刚收到来自 "创世节点"的通知，有个fresh meet加入网络了，叫做 “B”

… 至此，所有人都知道了B节点加入了网络，里面记载着B节点的相关信息，包括IP地址，包括udp端口号

此时C节点也要加入网络，并且想要和B节点对话:

> C节点: hey，创世节点，我要加入到P2P网络里面，并且我要和B对话 创世节点: 兄弟们，刚刚有个叫做B的节点加入网络了，你们也去告诉其他节点，顺便看看有没有B这个节点 其他节点: 刚刚收到来自 "创世节点"的通知，有个fresh meet加入网络了，叫做 “C”，你们也看看有没有B这个节点 其他节点2: 收到通知，听说一个叫做C的节点在找一个B节点，我这里有它的信息，ip是xxxx.xxxx.xxx.xxxx, 端口10086 B节点: 有个C的家伙(ip: xxxx.xxxx.xxxx.xxxx, 端口1000)要找我

到这里，B获取到了C的信息，包括IP和端口，C也拿到了B的信息.

于是，他们两个就可以建立通信。消息流: B <----> C. 中间不经过任何服务器

用一张图来形容:

![Q9FlqS.png](https://s2.ax1x.com/2019/11/27/Q9FlqS.png)

##### 总结

在设计中，每个节点的功能都是一样的。如果需要加入到网络中，不一定跟创世节点链接

假设已存在的节点: 创世节点，A、B、C节点，此时有个D节点想要加入到网络。

那么D节点不一定非得链接到创世节点，可以链接到A、B、C中的任意一个节点，然后该节点再广播给其他节点说"Hey, 有个新人叫做D的加入了网络"。

这样所有人都知道，有个叫做D的节点存在，你可以和它通信，同时D节点和会同步已存在的节点。这样D节点也知道了其他节点的存在了。

#### BitTorrent协议

BT全名为BitTorrent,是一个p2p软件,你在下载download的同时，也在为其他用户提供上传upload，因为大家是“互相帮助”，所以不会随着用户数的增加而降低下载速度。

下面是一般用ftp，http等分享流程

<img src="https://s2.ax1x.com/2019/11/27/Q9FDZF.png" alt="Q9FDZF.png" style="zoom:50%;" />



下面是用BitTorrent分享的流程：

![Q9FsIJ.png](https://s2.ax1x.com/2019/11/27/Q9FsIJ.png)



其实跟ED也十分相似，**ED跟BT不同的地方**有:

- ED--要连上一个固定server BT--没有固定server,只要分享者制作出该分享档案的.torrent档公布出来便可

- ED--分享的人越多速度越快? BT--种子seed越多速度越快

- ED--世界性的分享 BT--团体性的分享(可做到速度保证)

- ED--知道在分享者的user name &速度 BT--没显示使用者/分享者名字

比起其它的P2P软件，BT有个独特的地方，它存在一个中间的WEB服务器，就是我们在发布的时所填写的announce。 该服务器提供了发布的统一管理，不像其它P2P软件那样到处去找哪些非常不稳定的个人服务器，相对起来让人安心的多。

该WEB服务器更大的作用是内网用户可以做 Send（下面会说明原理），这是其它软件无法做到的，但不好的地方是announce当机的时候就无法下载了。要知道P2P下载关键是要人气要高，announce停一下就搞到人气全没有了。

##### .torrent文件 的作用

大家都知道我们要用BT下载 ，就要先下载一个.torrent文件，这个文件到底有甚么呢

当您对一个文件（或者文件夹）制作成.torrent文件，实际上生成的.torrent文件里面主要包括了这些信息：

1. 这个文件（文件夹）中数据的SHA1值，比如一个1G的文件，如果按1M每块进行分块，则会被分为了1000块，torrent中就会有这1000个数据块的指纹值（SHA1的hash值），这个占据了torrent文件的绝大部分空间。这些值的目的是为了下载的过程中进行数据校验，确保数据收到的和当时源头制作torrent时的源文件100%一致，防止恶意数据攻击。
2. 一般制作torrent文件时，还会要指定一个或者多个Tracker的地址，比如[http://www.a.com:8080/announce](https://link.zhihu.com/?target=http%3A//www.a.com%3A8080/announce)这种地址。torrent里面一般也会存储了这个信息，这个其实也尤为重要。相当于记录了一个问询服务器的地址，这个问询服务器的作用，后面我再解释。
3. 文件或者文件夹内每个文件的名字，方便下载文件时，磁盘上直接命名好跟原始数据一样的目录结构、文件名。
4. 其它一些辅助和可扩展的信息，比如可以配置一个P2SP的http地址辅助下载，比如制作软件的名字、备注……。
5. 上面信息生成后，torrent会把1里面的这些信息，以及torrent里面的文件名等关键信息，再进行一次Hash，生成一个新的SHA1值，作为torrent的HASH值，也就是我们经常看到的下载软件里面对这个种子命名的一个唯一的hash值，也有的在magnet这种磁力链接中可以看到这个值，这就是torrent的唯一标记。

以上就是.torrent文件的内容，可以用记事本打开，但可能看到乱码。这个文件的编码遵循了bencode编码规则。但实际内容就主要是上面这些。所以，torrent可以理解为对原始数据的一些记录。

不难发现，Tracker 服务器是 P2P 网络的弱点，如果 Tracker 被关闭或封禁，你就无法找到同伴，也难以完成下载。

##### 下载原理

1. 下载软件拿到.torrent文件后，先进行打开，读取里面的这些信息，载入内存。
2. torrent中有Tracker的地址，下载软件拿到后，会去跟Tracker进行通讯，告诉Tracker：我要下载这个文件（通过hash值作为标记）； Tracker收到请求后，会记录这个客户端的公网IP（记录这厮在下载这个文件），同时呢，会返回给他：我这边还知道哪些人也在下载这个文件，一般是会返回200个IP（如果不够，当然就有多少返回多少）。 当然了，如果下载过程中，协议要求你必须5分钟跟tracker通讯一次，如果太久不通讯，tracker就认为你下线了，会把你从节点列表中删除的。
3. 客户端拿到了一堆IP后，就开始挨个去尝试连接，连上后就开始互相通讯了。比如告诉对方，我有哪些分块，问问对方有哪些，然后把我有的给对方；让对方把他有的某一块给我，这样就你来我往开始了下载。当然，如果很悲催的情况下，此时没别人在线，那就只能没速度了，就只能不停的找啊找啊找朋友，直到找到一个好朋友。

整个BT的基本原理和过程就是这样，当然，这只是BT的基本原理，要做好一个完善的BT还是有很多路要走的。比如：

1. 如果Tracker服务器出问题了，连不上这个问询的服务器，就拿不到周围的邻居节点，怎么办？---NB的BT发明者提出了DHT的概念，就算Tracker连不上了，也可以通过分布式哈希表DHT技术，通过DHT网络慢慢的寻找志同道合的邻居节点，只是没有Tracker那么直接那么快速，但慢一些总还是有机会找到邻居的。
2. 网络是复杂的，特别是我们聪明的各个运营商，为了不让自己的用户消耗太多带宽，很多地区的运营商对P2P是有封锁的，比如我知道的包括某城宽带等。他们的做法早期是分析协议里面的握手消息，BT的握手消息是明文的Bittorrent Protocol，粗暴的运营商看到刚建立完连接就发这个明文会立即断开连接；文明点的运营商看到后不断开连接，但会限速到20K让你慢慢下载。当然，BT后来也发明了加密协议，运营商也升级了封锁的设备，也开始模拟自己是一个客户端，尝试分析加密后的协议，精彩纷呈。所以，要做一个稳定的靠谱的P2P系统还是有不少坑要趟的。
3. 还有很多很多，比如BT对磁盘的调度、缓存的机制、文件分块的调度算法、服务器对几百万几千万用户量时的性能提升等等。

#### DHT

DHT全称叫分布式哈希表(Distributed Hash Table)，是一种分布式存储方法，一类可由键值来唯一标示的信息按照某种约定/协议被分散地存储在多个节点上，这样也可以有效地避免“中央集权式”的服务器（比如：tracker）的单一故障而带来的整个网络瘫痪。

实现DHT的技术/算法有很多种，常用的有：Chord, Pastry, Kademlia等。我们这里要研究的是Kademlia算法，因为BT及BT的衍生派（Mainline, Btspilits, Btcomet, uTorrent…），eMule及eMule各类Mods(verycd, easy emules, xtreme…)等P2P文件分享软件都是基于该算法来实现DHT网络的，BT采用Python的Kademlia实现叫作khashmir（科什米尔，印巴冲突地带？），有如下官网。

eMule采用C++的Kademlia实现干脆就叫作Kad，当然它们之间有些差别，但基础都是Kademlia。我们这里以BT-DHT为例进行分析介绍，下面说到的DHT都可以默认是BT-Kademlia-DHT。

 官方网站：https://www.tribler.org

#### 参考

1. https://www.zhihu.com/question/49829233
2. https://blog.csdn.net/qq_39521554/article/details/82531296
3. [BT 种子和磁力链接是如何工作的？](http://www.myzaker.com/article/5d1db31e8e9f0946f72c9cf0)
4. [P2P中DHT网络爬虫](http://codemacro.com/2013/05/19/crawl-dht/)









