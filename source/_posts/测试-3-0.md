---
title: 压力测试--JMeter
date: 2020-4-29 18:18:59
tags:
 - 测试
categories:
 - 测试
---

#### 性能测试

##### 知识点一:Java程序员为什么要学习性能测试

1. 项目正式上线之前,需要针对各种极限条件进行测试
2. 玩转JMeter，炫耀装X必备
3. 掌握性能测试可以给自己的简历添加亮点，提升面试成功率

<!--more-->

##### 知识点二:性能测试的概念

1. **性能测试：**是通过自动化的测试工具模拟多种正常、峰值以及异常负载条件来对系统的各项性能指标进行测试。**负载测试**和**压力测试**都属于性能测试，两者可以结合进行。
2. **负载测试：**通过负载测试，确定在各种工作负载下系统的性能，目标是测试当负载逐渐增加时，系统各项性能指标的变化情况。
3. **压力测试：**压力测试是通过确定一个系统的瓶颈或者不能接受的性能点，来获得系统能提供的最大服务级别的测试。它与负载测试的主要区别在于目的不同，确定一个最大的服务级别。

##### 知识点三:常见的性能测试场景

1. **并发性能测试：**并发性能测试的过程是一个负载测试和压力测试的过程，即逐渐增加负载，直到系统的瓶颈或者不能接收的性能点，通过综合分析交易执行指标和资源监控指标来确定系统并发性能的过程。

2. **疲劳强度测试：**疲劳测试是采用系统稳定运行情况下能够支持的最大并发用户数，持续执行一段时间业务，通过综合分析交易执行指标和资源监控指标来确定系统处理最大工作量强度性能的过程。
3. **大数据量测试：**大数据量测试可以分为两种类型：针对某些系统存储、传输、统计、查询等业务进行大数据量的独立数据量测试；与压力性能测试、负载性能测试、疲劳性能测试相结合的综合数据量测试方案。
4. **速度测试：**速度测试主要是针对关键有速度要求的业务进行测速度，可以在多次测试的基础上求平均值。

### JMeter

JMeter是一个桌面应用程序，可以用于执行功能测试和负载测试。虽然JMeter应用程序本身被设计为纯Java应用程序，但是它可以用于执行任何类型的web应用程序的负载测试。应用程序的最初意图是测试Apache Tomcat的性能，它基本上是一个web服务器。多年来，Jmeter随着用户界面的改进和其他特性的改进，使它成为企业web应用程序的一个可行的性能测试和负载测试工具。

在官网 http://jmeter.apache.org/ 下载JMeter，解压到本地

安装：直接解压zip文件

启动: 运行bin目录中的ApacheJMeter.jar文件

#### 入门

目标:对某个功能(自己随便找个接口)进行压力测试

JMeter里面的元件很多，逻辑控制器，配置元件，定时器，Sampler，监听器等等，先给出一个实例，慢慢了解元件的使用方法。测试一个网站，我们至少需要：用户，发送请求，查看结果这三个过程。

1.  新建测试计划

   ![tecorQ.png](https://s1.ax1x.com/2020/05/28/tecorQ.png)

2. 添加线程组（用户）

   在“测试计划”上右键，选择“添加”---“Thread Users”---“线程组”

   其中，对我们有影响的参数是线程数（设置发送请求的用户数目），Ramp-up period： 每个请求发生的总时间间隔，单位是秒，循环次数（请求发生的重复次数）。如果我们需要JMeter模拟五个请求者（也就是五个线程），每个请求者连续请求两次

   ![tehFg0.png](https://s1.ax1x.com/2020/05/28/tehFg0.png)

3. 添加请求

   我们要访问一个网页，比如是百度首页，则是http请求，则添加http请求，在线程组上右键---“添加”---“Sampler”---“HTTP请求”

   ![tehVDU.png](https://s1.ax1x.com/2020/05/28/tehVDU.png)

4. 添加监视器

   监视器的种类很多，根据自己的需要添加，我们选择“查看结果树”。在线程组上右键---“添加”---“监视器”---“查看结果树"

   ![tehnUJ.png](https://s1.ax1x.com/2020/05/28/tehnUJ.png)
   
   也可以使用聚合报告,对测试结果进行分析
   
   ![tehQ81.png](https://s1.ax1x.com/2020/05/28/tehQ81.png)

| Lable                           | 解释                                   |
| ------------------------------- | -------------------------------------- |
| 样本                            | 总测试数量                             |
| 平均值                          | 单个请求的平均响应时间                 |
| 中位数                          | 50%用户的响应时间                      |
| 90%百分位、95%百分位、99%百分位 | 90%、95%、99%用户的响应时间            |
| 最小值                          | 最小的响应时间                         |
| 最大值                          | 最大的响应时间                         |
| 异常%                           | 请求异常所占的百分比                   |
| 吞吐量                          | 每秒完成的请求数，吞吐量=请求数/总时间 |
| 接收                            | 每秒从服务器端接收到的数据量           |
| 发送                            | 每秒从客户端发送的请求的数量           |

#### 使用Jmeter的ForEach控制器实现网页爬虫

##### 1.目标:

​	使用Jmeter获取网络图片，并存到本地文件中

##### 2.步骤:

​	**2.1 新建测试计划，创建线程组**

![tehGDO.png](https://s1.ax1x.com/2020/05/28/tehGDO.png)

​	**2.2 在线程组下，新建一个Http请求取样器，访问 https://dp.pconline.com.cn//list/all_t5.html网址**

![tehdPA.png](https://s1.ax1x.com/2020/05/28/tehdPA.png)

​	**2.3 通过对响应信息的分析，我们发现，要获取的图片路径就是img标签的src，要获取的图片名称就是a标签的title**

![tehBxP.png](https://s1.ax1x.com/2020/05/28/tehBxP.png)

​	**2.4 在Http请求取样器下面，分别创建两个XPath提取器，用于解析响应结果**

​           第一个:解析图片链接，具体的XPath表达式为:`//a/img/@src`

![tehrKf.png](https://s1.ax1x.com/2020/05/28/tehrKf.png)

​		第二个:解析图片标题，具体的XPath表达式为:`//a/@title`

​	 **2.5 在线程组下添加一个调试取样器**

![tehyqS.png](https://s1.ax1x.com/2020/05/28/tehyqS.png)

​	 **2.6 添加查看结果树，并且运行，观察调试取样器的结果;图片路径的变量名是"src_数字"，总图片数量的变量名是"src_matchNr"，而图片名的变量名为"title_数字"**

![teh25j.png](https://s1.ax1x.com/2020/05/28/teh25j.png)

![te4YQ0.png](https://s1.ax1x.com/2020/05/28/te4YQ0.png)

​	 **2.7 在线程组下添加一个循环控制器，用于循环遍历获取图片,循环次数为${src_matchNr}**

![te4wo4.png](https://s1.ax1x.com/2020/05/28/te4wo4.png)

​	 **2.8 在循环控制器下添加一个计数器，用于获取每次循环的序号"num"**

![te46Qx.png](https://s1.ax1x.com/2020/05/28/te46Qx.png)

​		**2.9 在循环控制器下添加一个Http请求取样器**

```
请求的名字为"title_数字"，使用${__V(title_${num})}"可以获取到
请求路径为"src_数字"，使用${__V(src_${num})}可以获取到
```

![te4gOK.png](https://s1.ax1x.com/2020/05/28/te4gOK.png)

​	   **2.10 在Http请求取样器下添加一个"BeanShell后置处理程序"，将图片写入本地文件**

![te4WwD.png](https://s1.ax1x.com/2020/05/28/te4WwD.png)

**要执行的脚本如下**

```
prev.setDataEncoding("UTF-8");
byte[] result = prev.getResponseData();
String fileName = "c:\\\aa\\\_${__V(title_${num})}.jpg";
File file = new File(fileName);
FileOutputStream out = new FileOutputStream(file);
out.write(result);
out.close();
```

​	 **2.11 在查看结果树、和本地文件夹查看结果**

![te47lt.png](https://s1.ax1x.com/2020/05/28/te47lt.png)

#### 测试数据库服务器

测试mysql数据库插入数据的性能

1. 新建测试计划，添加线程组，并且加入mysql驱动的jar包

   ![teT91A.png](https://s1.ax1x.com/2020/05/28/teT91A.png)

2. 在线程组下添加JDBC Configuration配置元件，进行JDBC的配置

   ![teTk0f.png](https://s1.ax1x.com/2020/05/28/teTk0f.png)

3. 在线程组下添加一个计数器，记录每次执行的序号，存放到遍历num中

   ![teTacR.png](https://s1.ax1x.com/2020/05/28/teTacR.png)

4. 在线程组下添加一个JDBC  Request

   ![teTq3j.png](https://s1.ax1x.com/2020/05/28/teTq3j.png)

5. 添加查看结果树，观察执行结果；或者是添加聚合报告进行分析

   ![te7pUU.png](https://s1.ax1x.com/2020/05/28/te7pUU.png)

#### 使用Jmeter打造百万条数据

因测试去求，要打造100W用户数据，通过用户名、手机号、密码可以新增用户，其中要求用户名和密码不能重复

1. 创建测试计划，添加线程组

2. 在线程组下添加一个循环控制器，循环100W次

   ![teXwGT.png](https://s1.ax1x.com/2020/05/28/teXwGT.png)

   要执行的脚本如下:

   	phone=${__Random(111111111,999999999,)};
   	String a =String.valueOf(phone);
   	phone=${__Random(3,9,)};
   	String b =String.valueOf(phone);
   	a=1+b+a;
   	String account="Ge"+a;
   	vars.put("phone",a);
   	vars.put("account",account);

3. 在循环控制器下添加一个Http请求，用于添加用户

   ![teXrM4.png](https://s1.ax1x.com/2020/05/28/teXrM4.png)

